<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>great.markdown_make &mdash; GREAT 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> GREAT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction to GREAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">GREAT CODE</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GREAT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>great.markdown_make</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for great.markdown_make</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">MarkdownMake</span>

<span class="sd">all based on /s/tbd/python/markdown-make.py</span>
<span class="sd">see there for previous version</span>
<span class="sd">May 2018: removed extraneous code and tidied up</span>
<span class="sd">Dec 2019: possible issue with repeated cla&#39;s that need to be stripped from YAML</span>
<span class="sd">MOVED here to DocMaker for future development</span>

<span class="sd">v 1.0 Dec 2019</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">platform</span> <span class="kn">import</span> <span class="n">platform</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># for MarkdownMake</span>
<span class="n">CREATE_NO_WINDOW</span> <span class="o">=</span> <span class="mh">0x08000000</span>
<span class="n">CREATE_NEW_CONSOLE</span> <span class="o">=</span> <span class="mh">0x00000010</span>
<span class="n">TEMP_FILE_NAME</span> <span class="o">=</span> <span class="s1">&#39;dm-temp&#39;</span>
<span class="n">BEGIN_STRING</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{document}</span><span class="s1">&#39;</span>
<span class="n">END_STRING</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{document}</span><span class="s1">&#39;</span>
<span class="n">LOCAL_YAML</span> <span class="o">=</span> <span class="s1">&#39;local_build.yaml&#39;</span>  <span class="c1"># name of default yaml files for empty headers</span>
<span class="n">PLATFORM</span> <span class="o">=</span> <span class="s1">&#39;linux&#39;</span> <span class="k">if</span> <span class="n">platform</span><span class="p">()[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Linux&#39;</span> <span class="k">else</span> <span class="s1">&#39;win&#39;</span>


<span class="n">print_fun</span> <span class="o">=</span> <span class="nb">print</span>


<div class="viewcode-block" id="debug_print_fun"><a class="viewcode-back" href="../../code.html#great.markdown_make.debug_print_fun">[docs]</a><span class="k">def</span> <span class="nf">debug_print_fun</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">argv</span><span class="p">]))</span></div>


<div class="viewcode-block" id="markdown_make_main"><a class="viewcode-back" href="../../code.html#great.markdown_make.markdown_make_main">[docs]</a><span class="k">def</span> <span class="nf">markdown_make_main</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When called from ST3 argv will be like but comes from global, it is not passed in, remember</span>
<span class="sd">    [&#39;\\s\\tbd\\python\\Markdown_Make.py&#39;,</span>
<span class="sd">    &#39;C:\\S\\Teaching\\2018-01\\ACT3349\\Notes\\Final.md&#39;, &#39;Final&#39;]</span>

<span class="sd">    When called internally (as a burst) may also include ydic which is then</span>
<span class="sd">    used as the spec for all builds first arg is the name of this script</span>
<span class="sd">    second arg is the full name of the file being processes</span>
<span class="sd">    third arg is the stripped name of the file.</span>

<span class="sd">    This is specified in the build file:</span>
<span class="sd">    &quot;cmd&quot;: [&quot;python&quot;, &quot;\\s\\tbd\\python\\Markdown_Make.py&quot;, &quot;$file&quot;, &quot;$file_base_name&quot;]</span>
<span class="sd">    so there are other options.</span>

<span class="sd">    This batch file will open the md file, read the yaml and proceed accordingly.</span>
<span class="sd">    YAML can set variables...that&#39;s it</span>
<span class="sd">    This batch file is responsible for setting command line arg_dict</span>
<span class="sd">    Args you want set are prefixed with clarg:</span>

<span class="sd">    Pass through command line arg_dict specified in yaml with cla</span>
<span class="sd">    (command line argument) xcla will be ignored</span>

<span class="sd">    format files: will be specified in the templates...so there will be a</span>
<span class="sd">    sjm-beamer-template which will refer to the right fmt file etc.</span>
<span class="sd">    to and from formats are specified in the cla</span>

<span class="sd">    there is no include-header - all these options are in the base yaml</span>

<span class="sd">    there will be a header-includes: but that is a standard env variable</span>

<span class="sd">    will keep debug</span>

<span class="sd">    burst: true/false, build burst true/false, output directory default is c</span>
<span class="sd">    temp burst (which has img and pdf)</span>
<span class="sd">    creating link: &gt; mklink /j img c:\\s\\telos\\notes\\img</span>

<span class="sd">    if there is no YAML at the top looks up the directory tree for a file</span>
<span class="sd">    called LOCAL_YAML and uses that in place.</span>

<span class="sd">    mode = quick: run pandoc and then pdflatex separately (avoids multiple</span>
<span class="sd">    runs); if there is a template</span>
<span class="sd">    it is used via a first line %&amp;/s/telos/common/sjm-doc-template taken from</span>
<span class="sd">    the YAML</span>

<span class="sd">    :param argv:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">print_fun</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;markdown_make_main on </span><span class="si">{</span><span class="n">PLATFORM</span><span class="si">}</span><span class="s1">. JAN 04 2021 VERSION &#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_fun</span> <span class="o">=</span> <span class="n">debug_print_fun</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ARGS: </span><span class="si">{</span><span class="n">argv</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
        <span class="c1"># logger.info(&#39;Called from Python: setting cwd to parent directory&#39;)</span>
        <span class="n">original_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>

    <span class="c1"># update biblio file if we appear to be processing the book...</span>
    <span class="c1"># now a link...which appears not to work</span>
    <span class="c1"># mklink /h library.bib ../../biblio/library.bib</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">book</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;spectral_risk_measures_monograph&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> \
       <span class="nb">str</span><span class="p">(</span><span class="n">book</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;book-hack&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">update_book_bibfile</span><span class="p">()</span>

    <span class="c1"># fix the date</span>
    <span class="n">insert_date</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># read yaml or put in defaults if there is no YAML - allows easy creation of slides</span>
    <span class="n">txt</span><span class="p">,</span> <span class="n">has_yaml</span><span class="p">,</span> <span class="n">ydic</span> <span class="o">=</span> <span class="n">parse_yaml</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># pandoc started complaining about multiple cla args in YAML so take them out</span>
    <span class="c1"># print_fun(ydic)</span>
    <span class="c1"># fa = re.findall(r&#39;^cla[^\n]+\n&#39;, txt, re.MULTILINE)</span>
    <span class="c1"># print_fun(fa)</span>
    <span class="n">txt</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^cla[ ]*:[^\n]+\n&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Removed </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> cla clauses from txt&#39;</span><span class="p">)</span>

    <span class="c1"># insert_date function does NOT work for local-yaml builds</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="s1">&#39;&quot;Created {date:%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ydic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># print_fun(&#39;Date tester: &#39;, ydic[&#39;date&#39;], ydic[&#39;date&#39;][0])</span>
        <span class="k">if</span> <span class="n">ydic</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;now&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;insert date&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">]:</span>
            <span class="c1"># may or may not be in the text...</span>
            <span class="n">ydic</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="p">]</span>

    <span class="c1"># process @@@include statements</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_includes</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">txt</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;@@@&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># have work to do</span>
        <span class="c1"># first, substitute for all NNN specs</span>
        <span class="c1"># note, obvious issue if the first three chars do not</span>
        <span class="c1"># uniquely identify file</span>
        <span class="c1"># assumes you are in the current directory</span>
        <span class="n">file_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.md&quot;</span><span class="p">)}</span>
        <span class="n">color_includes</span> <span class="o">=</span> <span class="n">ydic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;color-includes&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">color_includes</span><span class="p">:</span>
            <span class="n">color_includes</span> <span class="o">=</span> <span class="n">color_includes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">txt</span><span class="p">,</span> <span class="n">n_includes</span> <span class="o">=</span> <span class="n">process_includes</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="n">color_includes</span><span class="p">,</span> <span class="n">n_includes</span><span class="p">,</span> <span class="n">file_map</span><span class="p">)</span>
        <span class="c1"># print_fun(&#39;processing includes&#39;, n_includes)</span>

    <span class="k">if</span> <span class="n">ydic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;burst&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># burst mode: burst: [do burst t/f], [do build t/f], outdira</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ydic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;burst&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">do_burst</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">do_build</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
                <span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;c:</span><span class="se">\\</span><span class="s1">temp</span><span class="se">\\</span><span class="s1">burst&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;temp/burst&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_dir</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">do_burst</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">print_fun</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bursting to </span><span class="si">{</span><span class="n">base_dir</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">burst_file</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">)</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="n">do_build</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_build</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;building burst...&#39;</span><span class="p">)</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
            <span class="n">proc_files</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="c1"># create new file for processing in all cases because need to strip cla clauses</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="p">(</span><span class="n">ydic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;show&#39;</span><span class="p">)</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">txt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">nfn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;TMP_</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">.md&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comments</span><span class="p">:</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;Revealing comments...&#39;</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">show_comments</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">nfn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_yaml</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ydic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cla&#39;</span><span class="p">,</span> <span class="s1">&#39;xcla&#39;</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="s1">&#39;xdebug&#39;</span><span class="p">]:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">:</span><span class="se">\t</span><span class="si">{:}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

    <span class="c1"># build the argument list</span>
    <span class="k">if</span> <span class="n">PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;steve&#39;</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">users</span><span class="se">\\</span><span class="si">{:}</span><span class="se">\\</span><span class="s2">appdata</span><span class="se">\\</span><span class="s2">local</span><span class="se">\\</span><span class="s2">pandoc</span><span class="se">\\</span><span class="s2">pandoc.exe&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">())]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pandoc.exe&quot;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pandoc&quot;</span><span class="p">]</span>

    <span class="c1"># append all cla&#39;s from the yaml</span>
    <span class="c1"># print_fun(ydic)</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="n">ydic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cla&#39;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># add the name of the file being processes!</span>
    <span class="n">args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">nfn</span><span class="p">]</span>

    <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">aux_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;cla&#39;</span> <span class="ow">in</span> <span class="n">ydic</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ydic</span><span class="p">[</span><span class="s1">&#39;cla&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;--data-dir&#39;</span><span class="p">:</span>
                <span class="n">data_dir</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">aux_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_dir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;/s/telos/common&#39;</span>
            <span class="n">aux_dir</span> <span class="o">=</span> <span class="s1">&#39;/s/telos/common/&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;S/TELOS/common&#39;</span><span class="p">)</span>
            <span class="n">aux_dir</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;S/TELOS/common&#39;</span><span class="p">)</span>
    <span class="n">debug_mode</span> <span class="o">=</span> <span class="n">ydic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;no&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># print_fun(debug_mode)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ready to execute</span><span class="se">\n</span><span class="si">{</span><span class="n">debug_mode</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">ydic</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># if called from Python</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">original_cwd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nfn</span>

    <span class="c1"># create a batch file of the build, often handy to have</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;make_last.bat&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;REM Last build</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;REM </span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">REM PDF Output: uncomment next line</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;REM </span><span class="si">{</span><span class="n">out</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">REM TeX Output</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">pdf</span><span class="se">\\</span><span class="s1">(.*)\.pdf&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">\1.tex&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/pdf/(.*)\.pdf&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;/\1.tex&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">debug_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;quick&#39;</span><span class="p">,</span> <span class="s1">&#39;maketexformat&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;makeformat&#39;</span><span class="p">,</span> <span class="s1">&#39;maketemplate&#39;</span><span class="p">):</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;EXECUTING MARKDOWN BUILD</span><span class="se">\n\n</span><span class="si">{:}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="c1"># print_fun(&#39;RAW args&#39;)</span>
        <span class="c1"># print_fun(args)</span>
    <span class="k">if</span> <span class="n">debug_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;no run&#39;</span><span class="p">,</span> <span class="s1">&#39;norun&#39;</span><span class="p">):</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;NO RUN MODE...no further processing</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="n">ydic</span><span class="p">[</span><span class="s1">&#39;cla&#39;</span><span class="p">])</span>
        <span class="c1"># print_fun(ydic)</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">data-dir&#39;</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">aux_dir&#39;</span><span class="p">,</span> <span class="n">aux_dir</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">debug_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;quick&#39;</span><span class="p">):</span>
        <span class="c1"># ASSUMES: building to beamer or tex making a pdf...this will work by making a tex file and then pdflatex&#39;ing it</span>
        <span class="c1"># run pandoc</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">new_filename</span> <span class="o">=</span> <span class="n">adjust_output_file</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">)</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;EXECUTING pandoc</span><span class="se">\n\n</span><span class="si">{:}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">creationflags</span><span class="o">=</span><span class="n">CREATE_NO_WINDOW</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="c1"># then run latex</span>
        <span class="n">tex_args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pdflatex&#39;</span><span class="p">,</span> <span class="s1">&#39;-output-directory=pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;-aux-directory=temp&#39;</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">]</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;EXECUTING tex</span><span class="se">\n\n</span><span class="si">{:}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tex_args</span><span class="p">)))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">tex_args</span><span class="p">,</span> <span class="n">creationflags</span><span class="o">=</span><span class="n">CREATE_NO_WINDOW</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">debug_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;maketexformat&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;makeformat&#39;</span><span class="p">,</span> <span class="s1">&#39;maketemplate&#39;</span><span class="p">):</span>
        <span class="c1"># make tex format file based on this file</span>
        <span class="c1"># finds tex filename name looking in the pandoc template file</span>
        <span class="c1"># creates a tex file for the fmt by stripping the contents out of the calling program</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;making tex format...&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">template_name</span> <span class="o">=</span> <span class="n">remove_template</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">TEMP_FILE_NAME</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Temp filename: </span><span class="si">{</span><span class="n">TEMP_FILE_NAME</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;EXECUTING pandoc</span><span class="se">\n\n</span><span class="si">{:}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">creationflags</span><span class="o">=</span><span class="n">CREATE_NO_WINDOW</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="c1"># gamble that you do NOT actually need to strip out the doc...the latexformat appears to indicate that...</span>
        <span class="c1"># for now will actually edit it</span>
        <span class="n">out_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">.tex&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TEMP_FILE_NAME</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span>
                                                                                         <span class="s1">&#39;/&#39;</span><span class="p">)</span>  <span class="c1"># this is a throwaway file</span>
        <span class="n">template_args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pdflatex&#39;</span><span class="p">,</span> <span class="s1">&#39;-aux-directory=</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aux_dir</span><span class="p">),</span> <span class="s1">&#39;-ini&#39;</span><span class="p">,</span> <span class="s1">&#39;-jobname=&quot;&#39;</span> <span class="o">+</span> <span class="n">template_name</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;&quot;&amp;pdflatex&quot;&#39;</span><span class="p">,</span>
                         <span class="s2">&quot;mylatexformat.ltx&quot;</span><span class="p">,</span> <span class="n">out_file_name</span><span class="p">]</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;EXECUTING tex format build</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template_args</span><span class="p">))</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template_args</span><span class="p">),</span> <span class="n">creationflags</span><span class="o">=</span><span class="n">CREATE_NO_WINDOW</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">debug_mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">creationflags</span><span class="o">=</span><span class="n">CREATE_NO_WINDOW</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">creationflags</span><span class="o">=</span><span class="n">CREATE_NO_WINDOW</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="process_includes"><a class="viewcode-back" href="../../code.html#great.markdown_make.process_includes">[docs]</a><span class="k">def</span> <span class="nf">process_includes</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="n">color_includes</span><span class="p">,</span> <span class="n">n_includes</span><span class="p">,</span> <span class="n">file_map</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iterative processing of include files</span>
<span class="sd">    file_map looks for nnn_something.md files in the current directory</span>
<span class="sd">    dn = directory name</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># changed pattern to allow importing nonmarkdown files, e.g. py sourcefiles</span>
    <span class="c1"># but, WTF, is this re??</span>
    <span class="n">includes</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;@@@include ([\./]*)([0-9]</span><span class="si">{3}</span><span class="s1">|[0-9A-Za-z])([^\n]+\.[a-z]+)?&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
    <span class="c1"># print_fun(includes)</span>
    <span class="k">for</span> <span class="n">res_</span> <span class="ow">in</span> <span class="n">includes</span><span class="p">:</span>
        <span class="n">original_match</span> <span class="o">=</span> <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res_</span><span class="p">)</span>
        <span class="c1"># print_fun(res_, file_map)</span>
        <span class="c1"># res_[1] looks for nnn type files and tries to find them in file_map</span>
        <span class="k">if</span> <span class="n">res_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">file_map</span><span class="p">[</span><span class="n">res_</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="c1"># print_fun(f&#39;REPLACING {res_} with {res}&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">original_match</span>
            <span class="c1"># print_fun(f&#39;using {&quot;&quot;.join(res_)} as {res}&#39;)</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Importing </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">n_includes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">res</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">repl</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">repl</span> <span class="o">=</span> <span class="n">strip_yaml</span><span class="p">(</span><span class="n">repl</span><span class="p">)</span>
                <span class="n">repl</span><span class="p">,</span> <span class="n">n_includes</span> <span class="o">=</span> <span class="n">process_includes</span><span class="p">(</span><span class="n">repl</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">n_includes</span><span class="p">,</span> <span class="n">file_map</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">color_includes</span><span class="p">:</span>
                    <span class="n">repl</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="se">\\</span><span class="s1">color</span><span class="se">{{</span><span class="si">{</span><span class="n">color_includes</span><span class="si">}</span><span class="se">}}</span><span class="s1"></span>
<span class="si">{</span><span class="n">repl</span><span class="si">}</span><span class="s1"></span>
<span class="se">\\</span><span class="s1">color</span><span class="se">{{</span><span class="s1">black</span><span class="se">}}</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;@@@include </span><span class="si">{</span><span class="n">original_match</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">repl</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">print_fun</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: File </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s1"> not found...ignoring&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">txt</span><span class="p">,</span> <span class="n">n_includes</span></div>


<div class="viewcode-block" id="strip_yaml"><a class="viewcode-back" href="../../code.html#great.markdown_make.strip_yaml">[docs]</a><span class="k">def</span> <span class="nf">strip_yaml</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    strip starging yaml, between first --- and next --- from text</span>

<span class="sd">    :param text:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;---&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">text</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stext</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">stext</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">stext</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ln</span> <span class="o">!=</span> <span class="s1">&#39;---&#39;</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stext</span><span class="p">[</span><span class="n">n</span><span class="p">:])</span></div>


<div class="viewcode-block" id="adjust_output_file"><a class="viewcode-back" href="../../code.html#great.markdown_make.adjust_output_file">[docs]</a><span class="k">def</span> <span class="nf">adjust_output_file</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">new_output_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    swap pdf/xx.pdf output for dir_name/xx.tex</span>
<span class="sd">    Used in quick mode and making template</span>

<span class="sd">    :param args:</span>
<span class="sd">    :param dir_name:</span>
<span class="sd">    :param new_output_name:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;-o&#39;</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;pdf/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;pdf</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">new_output_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">new_output_name</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">stem</span>
                <span class="n">args</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">/</span><span class="si">{:}</span><span class="s1">.tex&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">new_output_name</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">new_filename</span></div>


<div class="viewcode-block" id="remove_template"><a class="viewcode-back" href="../../code.html#great.markdown_make.remove_template">[docs]</a><span class="k">def</span> <span class="nf">remove_template</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    remove the arg to use template; called when you make the template</span>

<span class="sd">    :param args:</span>
<span class="sd">    :param output_file_name:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">dir_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">template_found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--template&#39;</span><span class="p">):</span>
            <span class="c1"># print_fun(&#39;FOUND&#39;)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># i =&#39;--template=/s/telos/common/sjm-doc-template.tex&#39;</span>
            <span class="c1"># eq_loc = i.find(&quot;=&quot;) + 1</span>
            <span class="c1"># dir_end = len(i) - i[::-1].find(&#39;/&#39;) - 1</span>
            <span class="c1"># dir_name = i[eq_loc:dir_end]</span>
            <span class="c1"># template_name = i[dir_end + 1:-4]</span>
            <span class="c1"># template_found = True</span>
            <span class="c1"># new</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dir_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">template_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">template_found</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># print_fun(template_name)</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">template_found</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">ERROR: making template, need cla: --template=/template name... command line option!</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;Args are </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="se">\n</span><span class="s1">Aborting.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">trash</span> <span class="o">=</span> <span class="n">adjust_output_file</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">output_file_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">template_name</span></div>


<span class="c1"># from pandoc_debug.py</span>
<span class="c1"># test burst</span>
<span class="c1"># base_dir = &#39;c:\\temp\\burst&#39;</span>
<span class="c1"># with open(&#39;c:\\s\\telos\\notes\\32.022.Verisk_blockchain.md&#39;) as f:</span>
<span class="c1">#     txt = f.read()</span>
<span class="c1">#</span>
<span class="c1"># burst_file(txt, base_dir)</span>

<div class="viewcode-block" id="burst_file"><a class="viewcode-back" href="../../code.html#great.markdown_make.burst_file">[docs]</a><span class="k">def</span> <span class="nf">burst_file</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    burst file into subfiles in base_dir</span>
<span class="sd">    name given by page no</span>

<span class="sd">    :param txt:</span>
<span class="sd">    :param base_dir:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">page_split</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(</span><span class="se">\n</span><span class="s1">##?[ </span><span class="se">\n</span><span class="s1">]|</span><span class="se">\n</span><span class="s1">\-\-[\-]+</span><span class="se">\n</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>

    <span class="c1"># is there YAML to split off?</span>
    <span class="k">if</span> <span class="n">page_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># does not start with yaml</span>
        <span class="n">start_at</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># starts with yaml</span>
        <span class="n">start_at</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">page_split</span><span class="p">[</span><span class="n">start_at</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">page_split</span><span class="p">[</span><span class="n">start_at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">])):</span>
        <span class="c1"># print_fun(i, tag, p.strip())</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;@@@&#39;</span><span class="p">:</span>
            <span class="c1"># do not bother with slides that are includes (could have multi includes on a page</span>
            <span class="c1"># ignore that for now)</span>
            <span class="c1"># find a possible name</span>
            <span class="n">pn</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">clean_filename</span><span class="p">(</span><span class="n">pn</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.md&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;page_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">.md&#39;</span>
            <span class="c1"># print_fun(f&#39;possible name: {fn}&#39;)</span>
            <span class="c1"># fn = f&#39;page_{i:03d}.md&#39;</span>
            <span class="n">ffn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ffn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">---&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tag</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="clean_filename"><a class="viewcode-back" href="../../code.html#great.markdown_make.clean_filename">[docs]</a><span class="k">def</span> <span class="nf">clean_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    file name maker: removes unacceptable filename characers such as * and ?</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">validFilenameChars</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;-_.() </span><span class="si">{</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="si">}{</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">cleanedFilename</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cleanedFilename</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">validFilenameChars</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="proc_files"><a class="viewcode-back" href="../../code.html#great.markdown_make.proc_files">[docs]</a><span class="k">def</span> <span class="nf">proc_files</span><span class="p">(</span><span class="n">base_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param base_dir:</span>
<span class="sd">    :param ydic:    dictionary of pandoc args</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ffns</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;*.md&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">ffn</span> <span class="ow">in</span> <span class="n">ffns</span><span class="p">:</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ffn</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># print_fun(f&#39;calling main {ffn}, {fn}&#39;)</span>
        <span class="n">markdown_make_main</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ffn</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_yaml"><a class="viewcode-back" href="../../code.html#great.markdown_make.parse_yaml">[docs]</a><span class="k">def</span> <span class="nf">parse_yaml</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read fn</span>
<span class="sd">    if has yaml, read and parse it, return ydic</span>

<span class="sd">    if no yaml find local_build.yaml file, read and parse it, return</span>
<span class="sd">    Find and read the default yaml file for fn, fn = full path to markdown file</span>
<span class="sd">    as passed to markdown make as argv[1]</span>

<span class="sd">    First it finds a &#39;local_build.yaml&#39; file by looking in the directory containing</span>
<span class="sd">    fn and then iterating up all its parent directories. Stops the first file it</span>
<span class="sd">    finds.</span>

<span class="sd">    Opens the yaml and performs a standard markdown make parse. Removes the abstract.</span>

<span class="sd">    Puts in the -o file name with appropriate extension</span>

<span class="sd">    Returns populated ydic</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;&#39;^([a-zA-Z\-]+) *: *([^\n]+)$&#39;&#39;&#39;</span><span class="p">)</span>
    <span class="n">ydic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">full_txt</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">has_yaml</span> <span class="o">=</span> <span class="p">(</span><span class="n">full_txt</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;---&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">has_yaml</span><span class="p">:</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">full_txt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">full_txt</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span>
        <span class="c1"># print_fun(txt)</span>
        <span class="c1"># print_fun()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># look for local build file</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="n">LOCAL_YAML</span>
            <span class="k">if</span> <span class="n">pl</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;Using default yaml </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pl</span><span class="p">))</span>
                <span class="k">break</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># put header includes all on one line</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\n +\-([^\n]+)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39; \1&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="c1"># read in (when processing burst pages ydic is passed in, hummm)</span>
    <span class="c1"># start in row 2</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s1">&#39;---&#39;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># results are a 1 based array, corresponding to \1 etc.</span>
            <span class="c1"># result will have two useful outputs in \1 and \2</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">PATTERN</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="c1"># print_fun(s)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="c1"># print_fun(l, key, value)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-o &#39;</span><span class="p">:</span>
                <span class="n">out_format</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">out_format</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;-o </span><span class="si">{:}{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="s1">&#39;pdf&#39;</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">out_format</span> <span class="o">==</span> <span class="s1">&#39;latex&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;-o </span><span class="si">{:}{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="s1">&#39;.tex&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Inadmissible type </span><span class="si">{:}</span><span class="s1"> passed as output option&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_format</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ydic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ydic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ydic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_yaml</span><span class="p">:</span>
        <span class="c1"># ?! just don&#39;t put an abstract in the local_build.yaml!</span>
        <span class="c1"># for k in [&#39;abstract&#39;]:</span>
        <span class="c1">#     if k in ydic:</span>
        <span class="c1">#         del ydic[k]</span>
        <span class="n">ydic</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()]</span>

    <span class="c1"># for k, v in ydic.items():</span>
    <span class="c1">#     print_fun(k, v)</span>
    <span class="c1"># print_fun(ydic[&#39;cla&#39;])</span>
    <span class="k">return</span> <span class="n">full_txt</span><span class="p">,</span> <span class="n">has_yaml</span><span class="p">,</span> <span class="n">ydic</span></div>


<div class="viewcode-block" id="insert_date"><a class="viewcode-back" href="../../code.html#great.markdown_make.insert_date">[docs]</a><span class="k">def</span> <span class="nf">insert_date</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If there is YAML put the date in to line 3 (---, title, author, date)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DATE_LINE</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;---</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="s1">&#39;date: &quot;Created {date:%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">}&quot;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">DATE_LINE</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Created&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">lines</span><span class="p">[</span><span class="n">DATE_LINE</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;now&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">DATE_LINE</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
                <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;Replacing date: now with &#39;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">print_fun</span><span class="p">(</span><span class="s2">&quot;Retaining original date&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_comments"><a class="viewcode-back" href="../../code.html#great.markdown_make.show_comments">[docs]</a><span class="k">def</span> <span class="nf">show_comments</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    show all &lt;!-- xxx --&gt; comments</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">start</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">color</span><span class="si">{blue}</span><span class="se">\n\\</span><span class="s1">footnotesize</span><span class="se">\n\\</span><span class="s1">begingroup</span><span class="se">\n\\</span><span class="s1">leftskip8em</span><span class="se">\n\\</span><span class="s1">rightskip</span><span class="se">\\</span><span class="s1">leftskip&#39;</span>
    <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">endgroup</span><span class="se">\n\\</span><span class="s1">color</span><span class="si">{black}</span><span class="se">\n\\</span><span class="s1">normalsize &#39;</span>
    <span class="n">lstart</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">color</span><span class="si">{blue}</span><span class="s1"> \[&#39;</span>
    <span class="n">lend</span> <span class="o">=</span> <span class="s1">&#39;\] </span><span class="se">\\</span><span class="s1">color</span><span class="si">{black}</span><span class="s1">&#39;</span>

    <span class="n">stext</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">open_groups</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stext</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s1">&#39;&lt;!--&#39;</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">start</span>
            <span class="n">open_groups</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># print_fun(&#39;open group...&#39;)</span>
        <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="s1">&#39;--&gt;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">open_groups</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">open_groups</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># print_fun(&#39;...close group&#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Close para group without open at line </span><span class="si">{}</span><span class="se">\n</span><span class="s1">Previous lines </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">stext</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&lt;!--&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">l</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;--&gt;&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">open_groups</span><span class="p">:</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Apparent </span><span class="si">{}</span><span class="s1"> nested groups at line </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">open_groups</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;!--&#39;</span><span class="p">,</span> <span class="n">lstart</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;--&gt;&#39;</span><span class="p">,</span> <span class="n">lend</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>

    <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">txt</span></div>

<div class="viewcode-block" id="update_book_bibfile"><a class="viewcode-back" href="../../code.html#great.markdown_make.update_book_bibfile">[docs]</a><span class="k">def</span> <span class="nf">update_book_bibfile</span><span class="p">():</span>
    <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;Updating bibliography file...&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">PLATFORM</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
            <span class="n">p_from</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/s/telos/biblio/library.bib&#39;</span><span class="p">)</span>
            <span class="n">p_to</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/s/telos/spectral_risk_measures_monograph/docs/library.bib&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_from</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;S/TELOS/Biblio/library.bib&#39;</span><span class="p">)</span>
            <span class="n">p_to</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="s1">&#39;S/TELOS/spectral_risk_measures_monograph/docs/library.bib&#39;</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">p_from</span><span class="p">,</span> <span class="n">p_to</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="s1">&#39;Update bib file failed&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="md_summary"><a class="viewcode-back" href="../../code.html#great.markdown_make.md_summary">[docs]</a><span class="k">def</span> <span class="nf">md_summary</span><span class="p">(</span><span class="n">filename_regex</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dir_path</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Summarize Markdown files in dir_name matching filename_regex to md and html files</span>

<span class="sd">    Stephen J. Mildenhall (c) 2017-2021</span>

<span class="sd">    see the end of file for some helpful pointer on using the re.match</span>

<span class="sd">    if out_name = &#39;&#39; returns a string</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_file_md</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">out_name</span><span class="si">}</span><span class="s1">.md&#39;</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">out_file_md</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">print_fun</span><span class="p">(</span><span class="n">out_file_md</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>

    <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^(#[#]*) (.*)$|^(```)&quot;</span><span class="p">)</span>
    <span class="n">tab</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>

    <span class="c1"># keep track of subtitles and section numbering</span>
    <span class="n">last</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">nos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">last_level</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filename_regex</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">f</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="si">:</span><span class="s1">s</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># do not start off in a code block</span>
            <span class="n">in_code_block</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">regexp</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">in_code_block</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># matched a section: how many #s?; note match groups are 1-based lists</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">last</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                            <span class="c1"># repeat, do nothing</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">nos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># top level title</span>
                                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">. **</span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">**</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="c1"># sub title, give numbers</span>
                                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">nos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># bullets</span>
                                <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tab</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> * </span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">last</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">last_level</span><span class="p">:</span>
                            <span class="c1"># reset deeper levels</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">last_level</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">nos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="n">last</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">last_level</span> <span class="o">=</span> <span class="n">l</span>
                    <span class="k">elif</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;```&#39;</span><span class="p">:</span>
                        <span class="c1">## in out code block</span>
                        <span class="n">in_code_block</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">in_code_block</span>

    <span class="k">if</span> <span class="n">out_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fo</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># process output to HTML</span>
        <span class="c1"># out_file_html = dir_path / f&#39;{out_name}.html&#39;</span>
        <span class="c1"># args = ( f&quot;/home/steve/anaconda3/bin/pandoc --standalone --metadata title:&#39;{out_name}&#39; &quot;</span>
        <span class="c1">#     &quot;-V author:&#39;Stephen J. Mildenhall&#39; &quot;</span>
        <span class="c1">#     &quot;-f markdown+smart -t html --css=../css/github.css &quot;</span>
        <span class="c1">#     f&quot;-o  {out_file_md.resolve()} {out_file_md.resolve()}&quot;)</span>
        <span class="c1"># print_fun(args)</span>
        <span class="c1"># subprocess.Popen(args)</span>
        <span class="k">return</span> <span class="n">out_file_md</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">markdown_make_main</span><span class="p">()</span>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Stephen J Mildenhall.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>