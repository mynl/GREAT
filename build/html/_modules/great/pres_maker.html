<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>great.pres_maker &mdash; GREAT 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> GREAT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction to GREAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Utilities Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html#module-great.markdown_make">MarkdownMake Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html#presentationmanager">PresentationManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html#module-great.image_tools">Image Toools, Watcher and SFile Crypto</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GREAT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>great.pres_maker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for great.pres_maker</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">PresentationManager: persist exhibits and tables and make overall presentation</span>

<span class="sd">Builds off doc_maker</span>

<span class="sd">    * Only makes presentations</span>
<span class="sd">    * Appendix and TOC</span>
<span class="sd">    * Removes unused options</span>
<span class="sd">    * Integrated into magics</span>


<span class="sd">Usage example::</span>

<span class="sd">    test_df = pd.DataFrame(dict(x=range(100), y=range(100,200)))</span>
<span class="sd">    f, ax = plt.subplots(1,3)</span>
<span class="sd">    f = test_df.plot(ax = ax[2])</span>

<span class="sd">    doc = DocMaker.DocMaker(&#39;notes/test1.md&#39;)</span>
<span class="sd">    doc.section(&#39;Here is the main title &#39;)</span>
<span class="sd">    doc.subsection(&#39;A dataframe section&#39;)</span>
<span class="sd">    doc.table(test_df.head(10), &#39;df1&#39;, caption=&#39;Here is a dataframe&#39;)</span>
<span class="sd">    doc.subsection(&#39;A Figure section&#39;)</span>
<span class="sd">    doc.figure(f, &#39;x_y&#39;, caption=&#39;Here is a 1x3 figure &#39;, size=&quot;height=30%&quot;)</span>
<span class="sd">    doc.text(&#39;Some closing thoughts. and a  bunch more stuff.&#39;)</span>

<span class="sd">    doc.write_markdown()</span>

<span class="sd">    doc.process()</span>

<span class="sd">v 1.0 Dec 2020 created PresentationManager from DocMaker</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">.markdown_make</span> <span class="kn">import</span> <span class="n">markdown_make_main</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">from</span> <span class="nn">pandas.io.formats.format</span> <span class="kn">import</span> <span class="n">EngFormatter</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="c1"># import subprocess</span>
<span class="c1"># from platform import platform</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">IPython.core.magic</span> <span class="kn">import</span> <span class="n">Magics</span><span class="p">,</span> <span class="n">magics_class</span><span class="p">,</span> <span class="n">line_magic</span><span class="p">,</span> <span class="n">cell_magic</span><span class="p">,</span> <span class="n">line_cell_magic</span>
<span class="kn">from</span> <span class="nn">IPython.core.magic_arguments</span> <span class="kn">import</span> <span class="n">argument</span><span class="p">,</span> <span class="n">magic_arguments</span><span class="p">,</span> <span class="n">parse_argstring</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">get_ipython</span>
<span class="kn">from</span> <span class="nn">titlecase</span> <span class="kn">import</span> <span class="n">titlecase</span>
<span class="kn">import</span> <span class="nn">pypandoc</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">PrettyPrinter</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="c1"># import sys</span>
<span class="c1"># import re</span>
<span class="c1"># import subprocess</span>
<span class="c1"># import pathlib</span>
<span class="c1"># import struct</span>
<span class="c1"># import numpy as np</span>
<span class="c1"># import glob</span>
<span class="c1"># import string</span>
<span class="c1"># import unicodedata</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Size = dict(TINY = T = 300</span>
<span class="c1">#     VSMALL = VS = 400</span>
<span class="c1">#     SMALL = S = 500</span>
<span class="c1">#     MEDIUM = M = 600</span>
<span class="c1">#     LARGE = L = 700</span>
<span class="c1">#     XLARGE = XL = 800</span>


<div class="viewcode-block" id="PresentationManager"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager">[docs]</a><span class="k">class</span> <span class="nc">PresentationManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class level doc string...</span>

<span class="sd">    &quot;&quot;&quot;</span>

<span class="c1">#     __yaml__ = &quot;&quot;&quot;---</span>
<span class="c1"># title: &quot;{title}&quot;</span>
<span class="c1"># subtitle: &quot;{subtitle}&quot;</span>
<span class="c1"># author: Stephen J. Mildenhall</span>
<span class="c1"># date: &quot;{created}&quot;</span>
<span class="c1"># fontsize: {font_size}pt</span>
<span class="c1"># outertheme : metropolis</span>
<span class="c1"># innertheme : metropolis</span>
<span class="c1"># fonttheme  : structurebold</span>
<span class="c1"># colortheme : orchid</span>
<span class="c1"># institute: \\convexmark</span>
<span class="c1"># classoption: t</span>
<span class="c1"># numbersection: true</span>
<span class="c1"># toc: false</span>
<span class="c1"># filter: pandoc-citeproc</span>
<span class="c1"># bibliography: /S/TELOS/biblio/library.bib</span>
<span class="c1"># csl: /S/TELOS/biblio/journal-of-finance.csl</span>
<span class="c1"># link-citations: true</span>
<span class="c1"># header-includes:</span>
<span class="c1">#     - \\input{{general2021.tex}}</span>
<span class="c1">#     - \\geometry{{paper=legalpaper, landscape, mag=2000, truedimen}}</span>
<span class="c1"># cla: --top-level-division=section</span>
<span class="c1"># cla: --slide-level=2</span>
<span class="c1"># cla: --standalone</span>
<span class="c1"># cla: -f markdown+smart+yaml_metadata_block+citations{pdf_engine}</span>
<span class="c1"># cla: -o pdf</span>
<span class="c1"># cla: --filter pandoc-citeproc</span>
<span class="c1"># cla: -t beamer</span>
<span class="c1"># debug: true</span>
<span class="c1"># ---</span>
<span class="c1">#</span>
<span class="c1"># &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PresentationManager.__init__"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        builds_id -&gt; specification of portfolio, key, base_dir etc.</span>
<span class="sd">        tops_id = None -&gt; make contents etc.</span>

<span class="sd">        Originally::</span>

<span class="sd">            title, subtitle, key, base_dir, *, top_name=&#39;&#39;, top_value=&#39;&#39;, file_name=&#39;&#39;, fig_format=&#39;pdf&#39;,</span>
<span class="sd">            output_style=&#39;with_table&#39;, default_float_fmt=None, tidy=False, tacit_override=False,</span>
<span class="sd">            pdf_engine=&#39;&#39;)</span>

<span class="sd">        file_name of output, including extension::</span>

<span class="sd">                 pdf_engine=&#39;cla: --pdf-engine=lualatex&#39;</span>

<span class="sd">        base_dir should be notes (but you need to state that to avoid screw ups)</span>

<span class="sd">        key = short vignette name prepended to name of all tables and image files; goes with title... uber level</span>
<span class="sd">        file_name can be a/b/c/file.md</span>

<span class="sd">        all intermediate dirs created</span>

<span class="sd">        images in a/b/c/img</span>

<span class="sd">        tidy: search through the subfolders of the base output and delete all files key-*.*</span>

<span class="sd">        depending on how you name the key the existing pdf file may be deleted.</span>
<span class="sd">        key = vig-{vig}-something and file = key.md then it will NOT be because only key-*.* files</span>
<span class="sd">        are deleted. This is the recommended approach and is the default if key is &#39;&#39;.</span>

<span class="sd">        if tacit_override then override tacit command and show anyway (tables and blobs only)</span>


<span class="sd">        title</span>

<span class="sd">        key  becomes key-top_value</span>
<span class="sd">        top_name  Module, Part etc.</span>
<span class="sd">        top_value  A, B  or I, II or whatever</span>
<span class="sd">        subtitle ==&gt; top_name top_value subtitle</span>
<span class="sd">        filename ==&gt; key top_value (upper case)  [can ne over ridden]</span>


<span class="sd">        top_name: Part | Module etc.</span>
<span class="sd">        top_value: A, B, I, II etc.</span>

<span class="sd">        :param file_name:</span>
<span class="sd">        :param base_dir: where to store output, default ./notes</span>
<span class="sd">        :param key: (becomes key-top_value, prepended to file names to cluster them. Should be unique to the doc.</span>
<span class="sd">        :param title:</span>
<span class="sd">        :param fig_format:</span>
<span class="sd">        :param output_style: caption (caption in main doc just numbers in include), in-line (all in main doc) or with_table (all in include file)</span>
<span class="sd">        :param default_float_fmt:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="n">config_file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: file </span><span class="si">{</span><span class="n">config_file</span><span class="si">}</span><span class="s1"> does not exist.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># get all the other variables defined in init:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builds_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># other class variables related to config file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tops_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">option_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># read in builds level global variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># files are named key-top_value-...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># file specific, set manually</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_dir_name</span> <span class="o">=</span> <span class="s1">&#39;table&#39;</span>

        <span class="c1"># admin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_format</span> <span class="o">=</span> <span class="s1">&#39;pdf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_style</span> <span class="o">=</span> <span class="s1">&#39;with_table&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdf_engine</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_float_fmt</span> <span class="o">=</span> <span class="n">PresentationManager</span><span class="o">.</span><span class="n">default_float_format</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">capital_standard</span> <span class="o">=</span> <span class="mf">0.996</span>

        <span class="c1"># unless over-ridden, start counting at 1, appendices count negative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appendix</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slides</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sios</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># starts in base self.config: active and not in debug mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tacit_override</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug_state</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># avoid using dm because updated gets in a loop on the dates...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_dm_file</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PresentationManager.activate"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.activate">[docs]</a>    <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">subtitle</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">top_name</span><span class="p">,</span> <span class="n">top_value</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">filestem</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        set all the options to work independently of a config file</span>

<span class="sd">        key = pirc</span>
<span class="sd">        top_value = Ia  (drives file name and fig/table saved name)</span>
<span class="sd">        raw_top_value I excludes options (for section names and TOC)</span>
<span class="sd">        top_name = chapter, module, etc.</span>

<span class="sd">        for files the name is {key}-{top_value}-...</span>
<span class="sd">        the main file is callled {key}-{top_value}.md unless different filestem provided</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="n">subtitle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_name</span> <span class="o">=</span> <span class="n">top_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_value</span> <span class="o">=</span> <span class="n">top_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span> <span class="o">=</span> <span class="n">top_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">top_value</span><span class="si">}</span><span class="s1">.md&#39;</span> <span class="k">if</span> <span class="n">filestem</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filestem</span><span class="si">}</span><span class="s1">.md&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_complete_setup</span><span class="p">()</span></div>

<div class="viewcode-block" id="PresentationManager.activate_build"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.activate_build">[docs]</a>    <span class="k">def</span> <span class="nf">activate_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builds_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spec for portfolio etc.</span>

<span class="sd">        :param builds_id:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builds_id</span> <span class="o">=</span> <span class="n">builds_id</span>

        <span class="c1"># specification of course, portfolio etc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">[</span><span class="s1">&#39;builds&#39;</span><span class="p">][</span><span class="n">builds_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fig_format&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;output_style&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdf_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;pdf_engine&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_dir&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">capital_standard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;capital_standard&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># read in builds level global variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="PresentationManager.activate_top"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.activate_top">[docs]</a>    <span class="k">def</span> <span class="nf">activate_top</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tops_id</span><span class="p">,</span> <span class="n">option_id</span><span class="p">,</span> <span class="n">tidy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activate presentation for a particular top level part, chapter, module (the top_name)</span>
<span class="sd">        Corresponds to the different ipymd/md files that do the work to make the presentations.</span>

<span class="sd">        Output focus; the book of business is defined in builds</span>

<span class="sd">        option_id is appended to top_value for a distinguishing key</span>

<span class="sd">        :param tops_id:</span>
<span class="sd">        :param option_id:</span>
<span class="sd">        :param tidy:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># for this specific document</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tops_id</span> <span class="o">=</span> <span class="n">tops_id</span>
        <span class="n">top</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">[</span><span class="s1">&#39;tops&#39;</span><span class="p">][</span><span class="n">tops_id</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span> <span class="o">=</span> <span class="n">top</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span> <span class="o">=</span> <span class="n">top</span><span class="p">[</span><span class="s1">&#39;top_value&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">option_id</span> <span class="o">=</span> <span class="n">option_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_id</span>

        <span class="c1"># no choice of filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">.md&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_complete_setup</span><span class="p">()</span>
        <span class="c1"># tidy up</span>
        <span class="k">if</span> <span class="n">tidy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tidy_up</span><span class="p">()</span></div>

<div class="viewcode-block" id="PresentationManager._complete_setup"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager._complete_setup">[docs]</a>    <span class="k">def</span> <span class="nf">_complete_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        admin around files etc.</span>
<span class="sd">        ensures all directories exist</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># file specific, set manually</span>
        <span class="c1"># main file for output and ancillary directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;base_dir = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;output file = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s1">&#39;pdf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s1">&#39;img&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_dir_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># for debug output</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_dir</span> <span class="o">/</span> <span class="s1">&#39;pdf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># unless over-ridden, start counting at 1, appendices count negative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">section</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">appendix</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slides</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sios</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">front</span><span class="o">=</span><span class="n">StringIO</span><span class="p">(),</span> <span class="n">contents</span><span class="o">=</span><span class="n">StringIO</span><span class="p">(),</span> <span class="n">summary</span><span class="o">=</span><span class="n">StringIO</span><span class="p">(),</span> <span class="n">body</span><span class="o">=</span><span class="n">StringIO</span><span class="p">(),</span>
                                <span class="n">appendix</span><span class="o">=</span><span class="n">StringIO</span><span class="p">())</span>

        <span class="c1"># starts in base self.config: active and not in debug mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tacit_override</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># avoid using dm because updated gets in a loop on the dates...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_dm_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s1">&#39;dm2.md&#39;</span>

        <span class="c1"># start by writing the toc header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer_</span><span class="p">(</span><span class="s1">&#39;contents&#39;</span><span class="p">,</span> <span class="s1">&#39;## Contents</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error, </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s1"> has no item </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">builds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        list builds in the config file</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">[</span><span class="s1">&#39;builds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;* `</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">` </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="si">}{</span><span class="s2">&quot;, **active**&quot;</span> <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">builds_id</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">Markdown</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        list tops in the config file</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;| top_value | key | Subtitle | File |</span><span class="se">\n</span><span class="s1">&#39;</span> \
            <span class="s1">&#39;|:----:|:------|:--------------------------------------|:--------------------|</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">[</span><span class="s1">&#39;tops&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;| `</span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;top_value&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">` | </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;subtitle&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> | </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">|</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">Markdown</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<div class="viewcode-block" id="PresentationManager.temp_write"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.temp_write">[docs]</a>    <span class="k">def</span> <span class="nf">temp_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        write to temporory file</span>

<span class="sd">        :param argv:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s2">&quot;dm_temp_file.md&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_file</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManager.temp_close"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.temp_close">[docs]</a>    <span class="k">def</span> <span class="nf">temp_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_file</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="PresentationManager.pretty"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.pretty">[docs]</a>    <span class="k">def</span> <span class="nf">pretty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pretty print the config file</span>
<span class="sd">        :param kind:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_dicts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">pprint</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>  <span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">pp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;build&#39;</span><span class="p">,</span> <span class="s1">&#39;builds&#39;</span><span class="p">]:</span>
            <span class="n">pp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;tops&#39;</span><span class="p">]:</span>
            <span class="n">pp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">[</span><span class="s1">&#39;tops&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gross&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">]:</span>
            <span class="n">pp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;gross_portfolio&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]:</span>
            <span class="n">pp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;net_portfolio&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="PresentationManager.reset"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        reset all buffers etc.</span>
<span class="sd">        helpful but lazy</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_top</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tops_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PresentationManager.describe_portfolio"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.describe_portfolio">[docs]</a>    <span class="k">def</span> <span class="nf">describe_portfolio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return markdown description of portfolio</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;line_descriptions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;* `</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">`: </span><span class="si">{</span><span class="n">ln</span><span class="si">}{</span><span class="n">d</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">s</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span>

    <span class="nd">@debug</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># when this changes to on delete the old file; also acts as a reset</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_dm_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug_dm_file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active</span>

    <span class="nd">@active</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">active</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tacit_override</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tacit_override</span>

    <span class="nd">@tacit_override</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">tacit_override</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tacit_override</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="PresentationManager.section_number"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.section_number">[docs]</a>    <span class="k">def</span> <span class="nf">section_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get the number / letter for the next section</span>

<span class="sd">        return the prefix string for the toc and slide (allows summary not to be numbered)</span>
<span class="sd">        :param buf:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># prefix = f&#39;{self.top_name} {self.top_value}&#39;</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="c1"># not sure this is a good idea...with versions it intros trivial differences</span>
        <span class="c1"># prefix = &#39;&#39;</span>
        <span class="k">if</span> <span class="n">buf</span> <span class="o">==</span> <span class="s1">&#39;body&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">section</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">section</span><span class="si">:</span><span class="s1">0&gt;2d</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">section</span>
        <span class="k">elif</span> <span class="n">buf</span> <span class="o">==</span> <span class="s1">&#39;summary&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">buf</span> <span class="o">==</span> <span class="s1">&#39;appendix&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appendix</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="c1"># c = &#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;[self.appendix]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">int_to_roman</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">appendix</span><span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Appendix </span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s1">. &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">appendix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Hopeless confusion!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManager.text"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.text">[docs]</a>    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="n">tacit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add text to buffer</span>

<span class="sd">        only text function can create new sections</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">stxt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ln</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stxt</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;^# (.*)&#39;</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">s</span><span class="p">,</span> <span class="n">s_no</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">section_number</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">tl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_title</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ln</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tl</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">stxt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ln</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span><span class="p">,</span> <span class="n">s_no</span><span class="p">,</span> <span class="n">tl</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># title case ## headings too</span>
                <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;^## (.*)&#39;</span><span class="p">,</span> <span class="n">ln</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
                    <span class="n">stxt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">##  &#39;</span> <span class="o">+</span> <span class="n">titlecase</span><span class="p">(</span><span class="n">ln</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>

        <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stxt</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer_</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacit_override</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">txt</span><span class="p">))</span></div>

    <span class="c1"># aliases</span>
    <span class="n">write</span> <span class="o">=</span> <span class="n">text</span>
    <span class="n">blob</span> <span class="o">=</span> <span class="n">text</span>

<div class="viewcode-block" id="PresentationManager.figure"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.figure">[docs]</a>    <span class="k">def</span> <span class="nf">figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">new_slide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tacit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">promise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">option</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add a figure</span>

<span class="sd">        if f is a Figure it is used directly</span>
<span class="sd">        else call .get_figure</span>
<span class="sd">        else ValueError</span>
<span class="sd">        label = used for filename too</span>

<span class="sd">        :param f:</span>
<span class="sd">        :param label:</span>
<span class="sd">        :param buf:</span>
<span class="sd">        :param caption:</span>
<span class="sd">        :param height:</span>
<span class="sd">        :param new_slide:</span>
<span class="sd">        :param tacit:</span>
<span class="sd">        :param promise:  promise mode: just save the figure with appropriate name</span>
<span class="sd">        :param option:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Figure</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">AttritbuteError</span> <span class="k">as</span> <span class="n">ae</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cannot coerce input object </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> into a figure...ignoring&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ae</span>

        <span class="n">slide_caption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_label</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>
        <span class="c1"># label = self.make_safe_label(label)</span>
        <span class="k">if</span> <span class="n">option</span><span class="p">:</span>
            <span class="n">fig_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_format</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_format</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">fig_file_local</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;img/</span><span class="si">{</span><span class="n">fig_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">fig_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">fig_file</span><span class="si">}</span><span class="s1"> already exists...over-writing.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_format</span> <span class="o">==</span> <span class="s1">&#39;png&#39;</span> <span class="ow">and</span> <span class="s1">&#39;dpi&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;adding 600 dpi&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_file</span><span class="p">,</span>  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># not the caption, that can contain tex</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_underscores</span><span class="p">(</span><span class="n">caption</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Caption contains unescaped underscores _. You must ensure they are in dollars.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">caption</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">fig_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;![</span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s1"> &#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig_text</span> <span class="o">=</span> <span class="s1">&#39;![&#39;</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">fig_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">label</span><span class="se">{{</span><span class="s1">fig:</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="se">}}</span><span class="s1">&#39;</span>
        <span class="n">fig_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;](</span><span class="si">{</span><span class="n">fig_file_local</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="k">if</span> <span class="n">height</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">fig_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">height=</span><span class="si">{</span><span class="n">height</span><span class="si">}</span><span class="s1">%</span><span class="se">}}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">caption</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># suppresses &quot;Figure&quot; in pandoc</span>
            <span class="c1"># https://stackoverflow.com/questions/45030895/how-to-add-an-image-with-alt-tag-but-without-caption-in-pandoc</span>
            <span class="n">fig_text</span> <span class="o">+=</span> <span class="s1">&#39;  </span><span class="se">\\</span><span class="s1">&#39;</span>
        <span class="n">fig_text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">new_slide</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">promise</span><span class="p">:</span>
            <span class="c1"># need to write in one row so that debug mode write correctly to dm.md</span>
            <span class="n">text_out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## </span><span class="si">{</span><span class="n">slide_caption</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">fig_text</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">promise</span><span class="p">:</span>
            <span class="c1"># not new slide, not promise</span>
            <span class="n">text_out</span> <span class="o">=</span> <span class="n">fig_text</span>
        <span class="k">elif</span> <span class="n">promise</span><span class="p">:</span>
            <span class="c1"># don&#39;t write anything</span>
            <span class="k">return</span> <span class="n">fig_text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected &#39;</span><span class="p">)</span>

        <span class="c1"># actually write output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer_</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">text_out</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacit_override</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">text_out</span><span class="p">))</span></div>

<div class="viewcode-block" id="PresentationManager.save"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">filestem</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        just save body string to filename</span>
<span class="sd">        return the relevant include file</span>

<span class="sd">        :param self:</span>
<span class="sd">        :param filename:</span>
<span class="sd">        :param body:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filestem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_safe_label</span><span class="p">(</span><span class="n">filestem</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">filestem</span><span class="si">}</span><span class="s1">.md&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">filestem</span><span class="si">}</span><span class="s1">.md&#39;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="n">filename</span>

        <span class="k">with</span> <span class="n">file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;@@@include </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span></div>

<div class="viewcode-block" id="PresentationManager.make_label"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.make_label">[docs]</a>    <span class="k">def</span> <span class="nf">make_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="c1"># prepend option id on label to avoid collisions</span>
        <span class="k">if</span> <span class="n">option</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">option_id</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_safe_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_name</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">label</span></div>

<div class="viewcode-block" id="PresentationManager.tikz_table"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.tikz_table">[docs]</a>    <span class="k">def</span> <span class="nf">tikz_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">=</span><span class="s1">&#39;body&#39;</span><span class="p">,</span>
                   <span class="n">new_slide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tacit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">promise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">float_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">show_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.717</span><span class="p">,</span>
                   <span class="n">figure</span><span class="o">=</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="n">hrule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">option</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">vrule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sparsify</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a table using TikZ formatter</span>

<span class="sd">        label used as file name</span>
<span class="sd">        force_float = convert input to float first (makes a copy) for col alignment</span>

<span class="sd">        output_style as table</span>

<span class="sd">        1. with_table : all output in @@@ file and include in main md file; use when caption is generic</span>
<span class="sd">        1. caption:   puts caption text in the main markdown file, use when caption will be edited</span>
<span class="sd">        1. inline: all output in md file directly (not recommended)</span>

<span class="sd">        label and columns have _ escaped for TeX but the caption is not - so beware!::</span>

<span class="sd">            fn_out=None, float_format=None, tabs=None,</span>
<span class="sd">                show_index=True, scale=0.717, height=1.5, column_sep=2, row_sep=0,</span>
<span class="sd">                figure=&#39;figure&#39;, color=&#39;blue!0&#39;, extra_defs=&#39;&#39;, lines=None,</span>
<span class="sd">                post_process=&#39;&#39;, label=&#39;&#39;, caption=&#39;&#39;</span>

<span class="sd">        :param df:</span>
<span class="sd">        :param label:</span>
<span class="sd">        :param caption:</span>
<span class="sd">        :param buf:</span>
<span class="sd">        :param new_slide:</span>
<span class="sd">        :param tacit:</span>
<span class="sd">        :param promise:</span>
<span class="sd">        :param float_format:</span>
<span class="sd">        :param tabs:</span>
<span class="sd">        :param show_index:</span>
<span class="sd">        :param scale:</span>
<span class="sd">        :param figure:</span>
<span class="sd">        :param hrule:</span>
<span class="sd">        :param equal:</span>
<span class="sd">        :param option:</span>
<span class="sd">        :param latex:</span>
<span class="sd">        :param vrule:</span>
<span class="sd">        :param sparsify:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">promise</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_style</span> <span class="o">==</span> <span class="s1">&#39;with_table&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># store the table</span>
        <span class="k">if</span> <span class="n">option</span><span class="p">:</span>
            <span class="n">data_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;data/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.csv&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;data/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.csv&#39;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">float_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">float_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_float_fmt</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

        <span class="c1"># have to handle column names that may include _</span>
        <span class="c1"># For now assume there are not TeX names</span>
        <span class="n">slide_caption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_title</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_label</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">option</span><span class="p">)</span>

        <span class="c1"># check the caption, that can contain tex</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_underscores</span><span class="p">(</span><span class="n">caption</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Caption contains unescaped underscores _. You must ensure they are in dollars.&#39;</span><span class="p">)</span>

        <span class="c1"># do the work</span>
        <span class="n">s_table</span> <span class="o">=</span> <span class="n">df_to_tikz</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">,</span>
                             <span class="n">float_format</span><span class="o">=</span><span class="n">float_format</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="n">tabs</span><span class="p">,</span>
                             <span class="n">show_index</span><span class="o">=</span><span class="n">show_index</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="n">equal</span><span class="p">,</span>
                             <span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span> <span class="n">hrule</span><span class="o">=</span><span class="n">hrule</span><span class="p">,</span> <span class="n">vrule</span><span class="o">=</span><span class="n">vrule</span><span class="p">,</span> <span class="n">sparsify</span><span class="o">=</span><span class="n">sparsify</span><span class="p">,</span>
                             <span class="n">latex</span><span class="o">=</span><span class="n">latex</span><span class="p">,</span> <span class="n">clean_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># added a local bufer so output works better with debug model: need a single call to ._write_buffer_</span>
        <span class="n">sio_temp</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">option</span><span class="p">:</span>
            <span class="n">table_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.md&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">table_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">.md&#39;</span>
        <span class="k">if</span> <span class="n">table_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File </span><span class="si">{</span><span class="n">table_file</span><span class="si">}</span><span class="s1"> exists, over-writing.&#39;</span><span class="p">)</span>
        <span class="n">table_file_local</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">table_dir</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">table_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">new_slide</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">promise</span><span class="p">:</span>
            <span class="n">sio_temp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## </span><span class="si">{</span><span class="n">slide_caption</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># self._write_buffer_(buf, f&#39;## {slide_caption}\n\n&#39;)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;## </span><span class="si">{</span><span class="n">slide_caption</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_style</span> <span class="o">==</span> <span class="s1">&#39;inline&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_style</span> <span class="o">==</span> <span class="s1">&#39;in-line&#39;</span><span class="p">):</span>
            <span class="n">sio_temp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s_table</span><span class="p">)</span>
            <span class="c1"># self._write_buffer_(buf, s_table)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_style</span> <span class="o">==</span> <span class="s1">&#39;with_table&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">table_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s_table</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">promise</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;@@@include </span><span class="si">{</span><span class="n">table_file_local</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;@@@include </span><span class="si">{</span><span class="n">table_file_local</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">sio_temp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
                <span class="c1"># self._write_buffer_(buf, f&#39;@@@include {table_file_local}\n\n&#39;)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown option </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_style</span><span class="si">}</span><span class="s1"> for output_style passed to table.&#39;</span><span class="p">)</span>

        <span class="c1"># actually do the write</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_buffer_</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sio_temp</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tacit_override</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">float_format</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">caption</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">caption</span><span class="p">))</span></div>

<div class="viewcode-block" id="PresentationManager.default_float_format"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.default_float_format">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default_float_format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">neng</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        the endless quest for the perfect float formatter...</span>

<span class="sd">        tester::</span>

<span class="sd">            for x in 1.123123982398324723947 * 10.**np.arange(-23, 23):</span>
<span class="sd">                print(default_float_format(x))</span>

<span class="sd">        :param x:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ef</span> <span class="o">=</span> <span class="n">EngFormatter</span><span class="p">(</span><span class="n">neng</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
            <span class="k">elif</span> <span class="mf">1e-3</span> <span class="o">&lt;=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e6</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">.3g</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">,.2f</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">,.1f</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ans</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">,.0f</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">ef</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ans</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="PresentationManager.make_title"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.make_title">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_title</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        make s into a slide title (label/title interoperability)</span>

<span class="sd">        :param s:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># https://pypi.org/project/titlecase/#description</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">titlecase</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># .replace(&#39;-&#39;, &#39; &#39;))</span>
        <span class="c1"># from / to</span>
        <span class="c1"># for f, t in zip([&#39;Var &#39;, &#39;Tvar &#39;, &#39;Cv &#39;, &#39;Vs &#39;, &#39;Epd &#39;, &#39;Lr &#39;, &#39;Roe &#39;, &#39;Cle &#39;, &#39;Gdp&#39;, &#39;Gnp&#39;],</span>
        <span class="c1">#                 [&#39;VaR &#39;, &#39;TVaR &#39;, &#39;CV &#39;, &#39;vs. &#39;, &#39;EPD &#39;, &#39;LR &#39;, &#39;ROE &#39;, &#39;CLE &#39;, &#39;GDP&#39;, &#39;GNP&#39;]):</span>
        <span class="c1">#     s = s.replace(f, t)</span>
        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="PresentationManager.make_safe_label"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.make_safe_label">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_safe_label</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        convert label to suitable for tex lable and file name statements</span>

<span class="sd">        You can look at the Django framework for how they create a &quot;slug&quot; from arbitrary</span>
<span class="sd">        text. A slug is URL- and filename- friendly.</span>

<span class="sd">        The Django text utils define a function, slugify(), that&#39;s probably the gold standard</span>
<span class="sd">        for this kind of thing. Essentially, their code is the following.</span>

<span class="sd">        Normalizes string, converts to lowercase, removes non-alpha characters,</span>
<span class="sd">        and converts spaces to hyphens.</span>

<span class="sd">        https://stackoverflow.com/questions/295135/turn-a-string-into-a-valid-filename</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^\w\s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[-\s]+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="PresentationManager._write_buffer_"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager._write_buffer_">[docs]</a>    <span class="k">def</span> <span class="nf">_write_buffer_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        single point to write to buffer, allows overloading of other write related functions, such as tracking toc</span>
<span class="sd">        and making a tree diagram of the document</span>

<span class="sd">        not to be called externally, hence name</span>

<span class="sd">        :param buf:</span>
<span class="sd">        :param text:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># find the sections and add labels</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;^(## .+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">slide_heading</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slide_heading</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slides</span><span class="p">:</span>
                <span class="c1"># label the first occurrence of each slide name</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_slides</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">slide_heading</span><span class="p">)</span>
                <span class="n">new_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">slide_heading</span><span class="si">}</span><span class="s1"> </span><span class="se">\\</span><span class="s1">label</span><span class="se">{{</span><span class="s1">slide:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">make_safe_label</span><span class="p">(</span><span class="n">slide_heading</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span><span class="si">}</span><span class="se">}}\n</span><span class="s1">&#39;</span>
                <span class="c1"># count = 1: only replace the first occurrence</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">slide_heading</span><span class="p">,</span> <span class="n">new_text</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;New section&gt;&gt; </span><span class="si">{</span><span class="n">new_text</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># actually write the text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="n">buf</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># optionally write debug file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="s1">&#39;append&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;In debug mode...writing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">debug_dm_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">==</span> <span class="s1">&#39;append&#39;</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug_dm_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">slides</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slides</span>

<div class="viewcode-block" id="PresentationManager.tidy_up"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.tidy_up">[docs]</a>    <span class="k">def</span> <span class="nf">tidy_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        tidy up all project related files</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># tidying up</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;**/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-*.*&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span><span class="si">}</span><span class="s2"> existing file(s)...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">existing</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># just on principle</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking TMP files...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TMP_*.md&#39;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Deleting </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>

<div class="viewcode-block" id="PresentationManager.date"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.date">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">date</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;Created {date:%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S}&quot;</span><span class="o">.</span> \
            <span class="nb">format</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span></div>

<div class="viewcode-block" id="PresentationManager.dump_toc"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.dump_toc">[docs]</a>    <span class="k">def</span> <span class="nf">dump_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save the toc as a json file</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">-toc.json&#39;</span><span class="p">)</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing toc to </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManager.load_toc"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.load_toc">[docs]</a>    <span class="k">def</span> <span class="nf">load_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">-toc.json&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Read toc from </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TOC file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">toc.json not found.&#39;</span><span class="p">)</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">toc</span></div>

<div class="viewcode-block" id="PresentationManager.buffer"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.buffer">[docs]</a>    <span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decorate</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        assemble all the parts</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update toc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_toc</span><span class="p">(</span><span class="n">decorate</span><span class="p">)</span>
        <span class="c1"># assemble parts</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">buf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># sublime text-esque removal of white space</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; *</span><span class="se">\n</span><span class="s1">(</span><span class="se">\n</span><span class="s1">?)</span><span class="se">\n</span><span class="s1">*&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\n\1&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="PresentationManager.make_toc"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.make_toc">[docs]</a>    <span class="k">def</span> <span class="nf">make_toc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decorate</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sort the toc: Summary, Sections, Appendix</span>
<span class="sd">        if decorate != &#39;&#39; it will bold thaat row (for burst mode)</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># new SIO each time for contents...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="s1">&#39;contents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># there are no sections in the summary (section is # level)</span>
        <span class="c1"># toc_summary = sorted([i for i in self.toc if i[0].split()[2].strip() not in (&#39;Appendix&#39;, &#39;Section&#39;)],</span>
        <span class="c1">#                      key=sort_fun)</span>
        <span class="n">toc_body</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">toc_appendix</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span> <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="s1">&#39;contents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# Table of Contents</span><span class="se">\n</span><span class="s1">## </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_top_value</span><span class="si">}</span><span class="s1"> Contents</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">appendix_spacer_needed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">toc_body</span> <span class="o">+</span> <span class="n">toc_appendix</span><span class="p">:</span>
            <span class="n">s_</span> <span class="o">=</span> <span class="n">int_to_roman</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">s</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">appendix_spacer_needed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="s1">&#39;contents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">appendix_spacer_needed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">decorate</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span>
                <span class="c1"># annotate row</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="s1">&#39;contents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">grttocentry</span><span class="se">{{\\</span><span class="s1">bf </span><span class="si">{</span><span class="s2">&quot;Section&quot;</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Appendix&quot;</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">s_</span><span class="si">}</span><span class="se">}}{{\\</span><span class="s1">bf </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="s1">&#39;contents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">grttocentry</span><span class="se">{{</span><span class="si">{</span><span class="s2">&quot;Section&quot;</span> <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;Appendix&quot;</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">s_</span><span class="si">}</span><span class="se">}}{{</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManager.buffer_display"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.buffer_display">[docs]</a>    <span class="k">def</span> <span class="nf">buffer_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">()))</span></div>

<div class="viewcode-block" id="PresentationManager.buffer_persist"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.buffer_persist">[docs]</a>    <span class="k">def</span> <span class="nf">buffer_persist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">tacit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug_filename</span><span class="o">=</span><span class="s1">&#39;dm2.md&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        persist and write out the StringIO cache to a physical file</span>

<span class="sd">        if debug just write to dm.md and exit</span>

<span class="sd">        :param font_size:</span>
<span class="sd">        :param mode:   burst (separate files per section or all together or both</span>
<span class="sd">        :param toc:    for burst mode: read toc to number sections ignored if it doesn&#39;t exist</span>
<span class="sd">        :param tacit:  suppress markdown output of persisted file</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="ow">or</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">subtitle</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;yaml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="n">subtitle</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
                    <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span> <span class="n">pdf_engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf_engine</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">debug_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="n">debug_filename</span>
                <span class="k">with</span> <span class="n">debug_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing to file </span><span class="si">{</span><span class="n">debug_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">...and exiting.&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing to file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># in all mode, dump out the toc for future reference</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump_toc</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tacit</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;burst&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_toc</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">toc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">toc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span>
            <span class="c1"># full section name -&gt; (top number, section number)</span>
            <span class="n">toc_mapper</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">toc</span><span class="p">}</span>
            <span class="c1"># put in the correct section numbers according to the master toc</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc</span> <span class="o">=</span> <span class="p">[(</span><span class="o">*</span><span class="n">toc_mapper</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjusted toc = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">toc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># read buffers</span>
            <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">sbody</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;^(# .+)$&#39;</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="n">body_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sbody</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">sbody</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">])}</span>
            <span class="k">if</span> <span class="n">sbody</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pre first section not empty...Adding to summary.</span><span class="se">\n</span><span class="si">{</span><span class="n">sbody</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span> <span class="o">+</span> <span class="n">sbody</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">appendix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="s1">&#39;appendix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">appendix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">sappendix</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;^(# .+)$&#39;</span><span class="p">,</span> <span class="n">appendix</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
                <span class="n">appendix_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sappendix</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">sappendix</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">])}</span>
                <span class="k">if</span> <span class="n">appendix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pre first content before Appendix: not expected..ignoring</span><span class="se">\n</span><span class="si">{</span><span class="n">appendix</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">appendix_dict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="n">body_dict</span><span class="p">,</span> <span class="n">appendix_dict</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">section</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">top_no</span><span class="p">,</span> <span class="n">sec_no</span> <span class="o">=</span> <span class="n">toc_mapper</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writing </span><span class="si">{</span><span class="n">top_no</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">sec_no</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">s_</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sec_no</span><span class="si">:</span><span class="s1">0&gt;2d</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">sec_no</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">int_to_roman</span><span class="p">(</span><span class="o">-</span><span class="n">sec_no</span><span class="p">)</span>
                    <span class="n">fsec_no</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">top_no</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">s_</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">make_toc</span><span class="p">(</span><span class="n">decorate</span><span class="o">=</span><span class="n">sec_no</span><span class="p">)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;yaml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">top_value</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">subtitle</span><span class="o">=</span><span class="n">section</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
                            <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span> <span class="n">pdf_engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pdf_engine</span><span class="p">)</span>
                    <span class="k">with</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">top_no</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">s_</span><span class="si">}</span><span class="s1">-burst.md&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sios</span><span class="p">[</span><span class="s1">&#39;contents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">summary</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="c1"># summary attached to toc, comes before the body content</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1"># </span><span class="si">{</span><span class="n">top_no</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">sec_no</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManager.finish"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        json driven last steps, reads font size and mode (single, both burst) from the config file</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">font_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;font_size&#39;</span><span class="p">]</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_persist</span><span class="p">(</span><span class="n">font_size</span><span class="p">,</span> <span class="n">tacit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManager.process"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">tacit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write out and run pandoc to convert</span>
<span class="sd">        Can set font_size and margin here, default 10 and 1 inches.</span>

<span class="sd">        Set over_write = False and an existing markdown file will not be overwritten.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Currently inactive...returning&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buffer_persist</span><span class="p">(</span><span class="n">font_size</span><span class="p">,</span> <span class="n">tacit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_beamer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManager.process_burst"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.process_burst">[docs]</a>    <span class="k">def</span> <span class="nf">process_burst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        pandoc all the burst files</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-burst-*.md&#39;</span><span class="p">):</span>
            <span class="c1"># parallelize would be nice...</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_beamer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManager.clean_name"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.clean_name">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_name</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        escape underscores for using a name in a DataFrame index</span>

<span class="sd">        :param n:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="c1"># quote underscores that are not in dollars</span>
                <span class="k">return</span> <span class="s1">&#39;$&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">i</span> <span class="k">if</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">n</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">n</span></div>

<div class="viewcode-block" id="PresentationManager.clean_underscores"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.clean_underscores">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_underscores</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check s for unescaped _s</span>
<span class="sd">        returns true if all _ escaped else false</span>
<span class="sd">        :param s:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)])</span></div>

<div class="viewcode-block" id="PresentationManager.clean_index"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.clean_index">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_index</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        escape _ for columns and index</span>
<span class="sd">        whether multi or not</span>

<span class="sd">        !!! you can do this with a renamer...</span>

<span class="sd">        :param df:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">idx_names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
        <span class="n">col_names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">PresentationManager</span><span class="o">.</span><span class="n">clean_mindex_work</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">PresentationManager</span><span class="o">.</span><span class="n">clean_name</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># index</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">PresentationManager</span><span class="o">.</span><span class="n">clean_mindex_work</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">PresentationManager</span><span class="o">.</span><span class="n">clean_name</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">idx_names</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">col_names</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="PresentationManager.clean_mindex_work"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.clean_mindex_work">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_mindex_work</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">levels</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lv</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                <span class="n">repl</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">PresentationManager</span><span class="o">.</span><span class="n">clean_name</span><span class="p">,</span> <span class="n">lv</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="n">repl</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span></div>

<div class="viewcode-block" id="PresentationManager.make_beamer"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.make_beamer">[docs]</a>    <span class="k">def</span> <span class="nf">make_beamer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        make path_file = Path file object if possible</span>

<span class="sd">        :param path_file:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># make it if windows</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">())</span> <span class="o">==</span> <span class="s1">&#39;/home/steve&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Linux system...cannot make file&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;making file&#39;</span><span class="p">)</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="p">)</span>
            <span class="n">markdown_make_main</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">path_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">path_file</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManager.course_contents"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.course_contents">[docs]</a>    <span class="k">def</span> <span class="nf">course_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of modules and links</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../generated/pdf&#39;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">65</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">[</span><span class="s1">&#39;tops&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;pirc-</span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;top_value&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">.pdf&#39;</span>
            <span class="nb">print</span><span class="p">((</span><span class="n">p</span><span class="o">/</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* [</span><span class="si">{</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;subtitle&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">](pirc/</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* </span><span class="si">{</span><span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;subtitle&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> (coming soon)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">pypandoc</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;markdown&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../generated/html/pirc-course-contents.html&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">md</span><span class="p">,</span> <span class="n">html</span></div>

<div class="viewcode-block" id="PresentationManager.summarize"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.summarize">[docs]</a>    <span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize from config file</span>

<span class="sd">        based on markdown_make.md_summary()</span>

<span class="sd">        Stephen J. Mildenhall (c) 2021</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># sio = full summary</span>
        <span class="c1"># short = short summary that goes to website</span>
        <span class="n">sio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">short</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">git</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="c1"># start by pretty printing the config file</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;# **</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s1">** Configuration File</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;## Project Level Parameters</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;tops&#39;</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* `</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">` </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">top_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;top_name&#39;</span><span class="p">]</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">### </span><span class="si">{</span><span class="n">top_name</span><span class="si">}</span><span class="s1"> Contents</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">[</span><span class="s1">&#39;tops&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tops</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tv</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;top_value&#39;</span><span class="p">]</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* `</span><span class="si">{</span><span class="n">tv</span><span class="si">}</span><span class="s1">` </span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">### Portfolio Specification</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#### Gross</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;```</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gross_portfolio&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">```</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#### Net</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;```</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;net_portfolio&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">```</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;## Individual Module Contents</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^(#[#]*) (.*)$|^(```)&quot;</span><span class="p">)</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>

        <span class="c1"># keep track of subtitles and section numbering</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../generated&#39;</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">nos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">last_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># cut out duplicates</span>
        <span class="n">last_slide</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tops</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;top_value&#39;</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;pirc-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">.md&quot;</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="c1"># fourth argument returns before doing any real work</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;processing </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">resolved_f</span> <span class="o">=</span> <span class="n">markdown_make_main</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">resolved_f</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">resolved_f</span><span class="p">)</span>
                <span class="n">content_f</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;pdf/pirc-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
                <span class="k">if</span> <span class="n">content_f</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">content_f</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">)</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S%z</span><span class="si">}</span><span class="s1"> UTZ&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">updated</span> <span class="o">=</span> <span class="s1">&#39;not created&#39;</span>
                <span class="k">with</span> <span class="n">resolved_f</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">linked_st</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s1">](pirc-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.pdf)&#39;</span>
                    <span class="n">git_linked_st</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s1">](https://github.com/mynl/PIRC/blob/main/Python/</span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s1">)&#39;</span>
                    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">### </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">linked_st</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">short</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">linked_st</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">git</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">git_linked_st</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="c1"># do not start off in a code block</span>
                    <span class="n">in_code_block</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">regexp</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_code_block</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># matched a section: how many #s?; note match groups are 1-based lists</span>
                                <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">last</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                                    <span class="c1"># repeat, do nothing</span>
                                    <span class="k">pass</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># get rid of labels</span>
                                    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">label.*$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                                    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="c1"># presentation section level, no duplicates</span>
                                        <span class="n">nos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;* **</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">**</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="s1">&#39;Table of Contents&#39;</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Appendix&#39;</span><span class="p">:</span>
                                            <span class="n">short</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">* </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                            <span class="n">git</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">* </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="c1"># slide give numbers</span>
                                        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">last_slide</span><span class="p">:</span>
                                            <span class="k">pass</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">nos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                            <span class="n">last_slide</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">nos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># bullets</span>
                                        <span class="n">nos</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tab</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">* </span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                        <span class="c1"># if l == 3:</span>
                                        <span class="c1">#     short.write(f&quot;{tab*(l-1)}* {match.group(2):s}\n&quot;)</span>
                                    <span class="n">last</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">last_level</span><span class="p">:</span>
                                    <span class="c1"># reset deeper levels</span>
                                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">last_level</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                        <span class="n">nos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                        <span class="n">last</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                <span class="n">last_level</span> <span class="o">=</span> <span class="n">l</span>
                            <span class="k">elif</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;```&#39;</span><span class="p">:</span>
                                <span class="c1">## in out code block</span>
                                <span class="n">in_code_block</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">in_code_block</span>
                    <span class="n">short</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">* Last pdf update </span><span class="si">{</span><span class="n">updated</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># be tidy</span>
                <span class="n">resolved_f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s1"> (file does not exist)</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">short</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s1"> (coming soon)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">git</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">. </span><span class="si">{</span><span class="n">st</span><span class="si">}</span><span class="s1"> (coming soon)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">long_md</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">short_md</span> <span class="o">=</span> <span class="n">short</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">short_html</span> <span class="o">=</span> <span class="n">pypandoc</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">short_md</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;markdown&#39;</span><span class="p">)</span>
        <span class="n">git_md</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="c1"># git_html = pypandoc.convert(git_md, &#39;html&#39;, &#39;markdown&#39;)</span>
        <span class="n">stripper</span> <span class="o">=</span> <span class="s1">&#39;Individual Module Contents&#39;</span>
        <span class="n">long_html</span> <span class="o">=</span> <span class="n">pypandoc</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">long_md</span><span class="p">[</span><span class="n">long_md</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">stripper</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">stripper</span><span class="p">):],</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;markdown&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../generated/html/pirc-short-contents.html&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">short_html</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../generated/html/pirc-long-contents.html&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">long_html</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">long_md</span><span class="p">,</span> <span class="n">short_md</span><span class="p">,</span> <span class="n">git_md</span></div>

        <span class="c1"># process output to HTML</span>
        <span class="c1"># out_file_html = dir_path / f&#39;{out_name}.html&#39;</span>
        <span class="c1"># args = ( f&quot;/home/steve/anaconda3/bin/pandoc --standalone --metadata title:&#39;{out_name}&#39; &quot;</span>
        <span class="c1">#     &quot;-V author:&#39;Stephen J. Mildenhall&#39; &quot;</span>
        <span class="c1">#     &quot;-f markdown+smart -t html --css=../css/github.css &quot;</span>
        <span class="c1">#     f&quot;-o  {out_file_md.resolve()} {out_file_md.resolve()}&quot;)</span>
        <span class="c1"># print(args)</span>
        <span class="c1"># subprocess.Popen(args)</span>

<div class="viewcode-block" id="PresentationManager.uber_deck"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.uber_deck">[docs]</a>    <span class="k">def</span> <span class="nf">uber_deck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subtitle</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">pdf_engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        make a deck combining all available markdpown files</span>
<span class="sd">        try cla: --pdf-engine=lualatex if needed</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="c1"># generally need a beefier engine to build this deck...</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;yaml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="n">subtitle</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
                <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span> <span class="n">pdf_engine</span><span class="o">=</span><span class="n">pdf_engine</span><span class="p">)</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">y</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-?.md&#39;</span><span class="p">)):</span>
            <span class="k">with</span> <span class="n">fn</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">in_text</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ln</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="k">if</span> <span class="n">in_text</span><span class="p">:</span>
                        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ln</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">ln</span> <span class="o">==</span> <span class="s1">&#39;---&#39;</span><span class="p">:</span>
                        <span class="n">in_text</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">ln</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;subtitle: &#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found section: </span><span class="si">{</span><span class="n">ln</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">grttopdivider</span><span class="se">{{</span><span class="si">{</span><span class="n">ln</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="se">}}\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># yaml line, ignored</span>
                        <span class="k">pass</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s1">-uber.md&#39;</span>
        <span class="k">with</span> <span class="n">out</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span></div>

<div class="viewcode-block" id="PresentationManager.short_hash"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.short_hash">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">short_hash</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32encode</span><span class="p">(</span><span class="n">hasher</span><span class="o">.</span><span class="n">digest</span><span class="p">())[:</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span></div>

<div class="viewcode-block" id="PresentationManager.combine"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.combine">[docs]</a>    <span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        break pages of all files in PM into tops, sections and slides</span>
<span class="sd">        return as nice DataFrame</span>

<span class="sd">        self = PM object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># keep track of subtitles and section numbering</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span>
        <span class="n">tops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">[</span><span class="s1">&#39;tops&#39;</span><span class="p">]</span>

        <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(# .*)$|^(## .*)$|^(---)$&#39;</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="c1"># three groups here, plus what is between the dividers</span>
        <span class="n">ngroups</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tops</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;top_value&#39;</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">dir_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;pirc-</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">.md&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="c1"># fourth argument returns before doing any real work</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;processing </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">resolved_f</span> <span class="o">=</span> <span class="n">markdown_make_main</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># this is a TMP file</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">resolved_f</span><span class="p">)</span>
                <span class="n">resolved_f</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">resolved_f</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">resolved_f</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">stxt</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
                    <span class="n">split</span> <span class="o">=</span> <span class="p">[</span><span class="n">stxt</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">j</span> <span class="o">*</span> <span class="n">ngroups</span><span class="p">:</span><span class="n">j</span> <span class="o">*</span> <span class="n">ngroups</span> <span class="o">+</span> <span class="n">ngroups</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">stxt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ngroups</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;---&#39;</span><span class="p">:</span>
                        <span class="n">split</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="c1"># set the index to correspond to page numbers in the PDF (actual pages, not on-slide pages; no pauses)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">split</span><span class="p">,</span>
                                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="s1">&#39;dash&#39;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">],</span>
                                      <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
                    <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="c1"># be tidy</span>
                <span class="n">resolved_f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;section&#39;</span><span class="p">,</span> <span class="s1">&#39;slide&#39;</span><span class="p">,</span> <span class="s1">&#39;dash&#39;</span><span class="p">,</span> <span class="s1">&#39;txt&#39;</span><span class="p">])</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;# Table of Contents&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Top </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> Coming Soon&#39;</span><span class="p">]</span>
                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="n">dfall</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;top_value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_all</span><span class="p">[</span><span class="s1">&#39;tops&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;idx&#39;</span><span class="p">])</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfall</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfall</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dfall</span><span class="o">.</span><span class="n">content</span><span class="p">]</span>
        <span class="n">dfall</span><span class="p">[[</span><span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dfall</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;(##*) (.*)&#39;</span><span class="p">)</span>
        <span class="n">dfall</span> <span class="o">=</span> <span class="n">dfall</span><span class="p">[[</span><span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">short_hash</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dfall</span><span class="o">.</span><span class="n">content</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tops</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dfall</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;top_value&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">],</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;top_value&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">dfall</span> <span class="o">=</span> <span class="n">dfall</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_label</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">dfall</span></div>

<div class="viewcode-block" id="PresentationManager.combine_generic"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.combine_generic">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">combine_generic</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">hash_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">expand_includes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_yaml</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generic version of combine that will apply to anything (e.g., the book!)</span>

<span class="sd">        for PIRC</span>
<span class="sd">        columns = [&#39;section&#39;, &#39;slide&#39;, &#39;dash&#39;, &#39;txt&#39;]</span>

<span class="sd">        for the book</span>
<span class="sd">        columns = [&#39;chapter&#39;, &#39;section&#39;, &#39;subsection&#39;, &#39;dash&#39;, &#39;txt&#39;]</span>

<span class="sd">        :param dir_path:  where the files live</span>
<span class="sd">        :param pattern: glob pattern for files to combine</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># keep track of subtitles and section numbering</span>
        <span class="c1"># going to assume there are no comments in code...</span>

        <span class="c1"># make the search string</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;^(</span><span class="si">{</span><span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1"> .*)$|&#39;</span>
        <span class="n">s</span> <span class="o">+=</span>  <span class="s2">&quot;^(---)$&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using regex pattern </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="n">ngroups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">search</span> <span class="o">=</span> <span class="p">[</span><span class="n">dir_path</span><span class="p">]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
            <span class="n">search</span> <span class="o">=</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
            <span class="c1"># fourth argument returns before doing any real work</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;processing </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expand_includes</span><span class="p">:</span>
                <span class="n">resolved_f</span> <span class="o">=</span> <span class="n">markdown_make_main</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">f</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># this is a TMP file</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expanded to </span><span class="si">{</span><span class="n">resolved_f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">resolved_f</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">resolved_f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resolved_f</span> <span class="o">=</span> <span class="n">f</span>
            <span class="k">with</span> <span class="n">resolved_f</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">stxt</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
                <span class="n">split</span> <span class="o">=</span> <span class="p">[</span><span class="n">stxt</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">j</span> <span class="o">*</span> <span class="n">ngroups</span><span class="p">:</span><span class="n">j</span> <span class="o">*</span> <span class="n">ngroups</span> <span class="o">+</span> <span class="n">ngroups</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">stxt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ngroups</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">exclude_yaml</span> <span class="ow">and</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;---&#39;</span><span class="p">:</span>
                    <span class="n">split</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="c1"># set the index to correspond to page numbers in the PDF (actual pages, not on-slide pages; no pauses)</span>
                <span class="n">start</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">exclude_yaml</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">split</span><span class="p">,</span>
                                  <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                                  <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">+</span> <span class="n">start</span><span class="p">))</span>
                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="c1"># be tidy</span>
            <span class="k">if</span> <span class="n">expand_includes</span> <span class="ow">and</span> <span class="n">resolved_f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">resolved_f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="n">dfall</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;idx&#39;</span><span class="p">])</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfall</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfall</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dfall</span><span class="o">.</span><span class="n">content</span><span class="p">]</span>
        <span class="n">dfall</span><span class="p">[[</span><span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">dfall</span><span class="o">.</span><span class="n">ref</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="s1">&#39;(##*) (.*)&#39;</span><span class="p">)</span>
        <span class="n">dfall</span> <span class="o">=</span> <span class="n">dfall</span><span class="p">[[</span><span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfall</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">PresentationManager</span><span class="o">.</span><span class="n">short_hash</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">hash_length</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dfall</span><span class="o">.</span><span class="n">content</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfall</span><span class="o">.</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;ititle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">dfall</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;ititle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">indent</span> <span class="o">*</span> <span class="n">lvl</span> <span class="o">+</span> <span class="n">t</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">lvl</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dfall</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
        <span class="n">dfall</span> <span class="o">=</span> <span class="n">dfall</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">PresentationManager</span><span class="o">.</span><span class="n">remove_label</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dfall</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]]</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dfall</span></div>

<div class="viewcode-block" id="PresentationManager.remove_label"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.remove_label">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">remove_label</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">label{[^}]*}$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="PresentationManager.make_accordion"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.make_accordion">[docs]</a>    <span class="k">def</span> <span class="nf">make_accordion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        code for website</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    &lt;div id=&quot;accordion-toc&quot;&gt;</span>
<span class="s1">        &lt;form action=&#39;/&#39;&gt;&#39;&#39;&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">top</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">top_contents</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                    &lt;div class=&quot;form-group form-check&quot;&gt;</span>
<span class="s1">                        &lt;label class=&quot;form-check-label&quot;&gt;</span>
<span class="s1">                            &lt;input class=&quot;form-check-input&quot; type=&quot;checkbox&quot;&gt;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">hash</span><span class="si">}</span><span class="s1">)&lt;/input&gt;</span>
<span class="s1">                        &lt;/label&gt;</span>
<span class="s1">                    &lt;/div&gt;&#39;&#39;&#39;</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="k">else</span> <span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                        &lt;div class=&quot;form-group form-check&quot;  style=&quot;text-indent: 2em&quot;&gt;</span>
<span class="s1">                            &lt;label class=&quot;form-check-label&quot;&gt;</span>
<span class="s1">                                &lt;input class=&quot;form-check-input&quot; type=&quot;checkbox&quot;&gt;[</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">hash</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">remove_label</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s1"> &lt;/input&gt;</span>
<span class="s1">                            &lt;/label&gt;</span>
<span class="s1">                        &lt;/div&gt;&#39;&#39;&#39;</span>
                        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">kind</span><span class="o">==</span><span class="s1">&#39;##&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">top_contents</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">                &lt;li&gt; Coming soon. &lt;/li&gt;&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            &lt;div class=&quot;card&quot;&gt;</span>
<span class="s1">                &lt;div class=&quot;card-header&quot;&gt;</span>
<span class="s1">                  &lt;a class=&quot;card-link&quot; data-toggle=&quot;collapse&quot; href=&quot;#</span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="s1">&quot;&gt;</span>
<span class="s1">                    </span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">title</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">)</span>
<span class="s1">                  &lt;/a&gt;</span>
<span class="s1">                &lt;/div&gt;</span>
<span class="s1">                &lt;div id=&quot;</span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="s1">&quot; class=&quot;collapse show&quot; data-parent=&quot;#accordion-toc&quot;&gt;</span>
<span class="s1">                  &lt;div class=&quot;card-body&quot;&gt;</span>
<span class="s1">                    &lt;div class=&quot;form-group form-check&quot;&gt;</span>
<span class="s1">                        &lt;label class=&quot;form-check-label&quot;&gt;</span>
<span class="s1">                            &lt;input class=&quot;form-check-input&quot; type=&quot;checkbox&quot;&gt;Select All&lt;/input&gt;</span>
<span class="s1">                        &lt;/label&gt;</span>
<span class="s1">                    &lt;/div&gt;</span><span class="si">{</span><span class="n">top_contents</span><span class="si">}</span><span class="s1"></span>
<span class="s1">                  &lt;/div&gt;</span>
<span class="s1">                &lt;/div&gt;</span>
<span class="s1">            &lt;/div&gt;&#39;&#39;&#39;</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        &lt;/form&gt;</span>
<span class="s1">    &lt;/div&gt;</span>
<span class="s1">    &#39;&#39;&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="s1">&#39;html/pirc-short-contents.html&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">sio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>

<div class="viewcode-block" id="PresentationManager.make_deck"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.make_deck">[docs]</a>    <span class="k">def</span> <span class="nf">make_deck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">subtitle</span><span class="p">,</span> <span class="n">handout</span><span class="p">,</span> <span class="n">filestem</span><span class="p">,</span> <span class="o">*</span><span class="n">hash_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        create a doc from a list of slide hashes</span>
<span class="sd">        ``df = result of running self.combine()``</span>

<span class="sd">        call either ``*list_of_hashes`` or ``hash1, hash2, ....``</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">filestem</span><span class="si">}</span><span class="s1">.md&#39;</span>
        <span class="k">with</span> <span class="n">file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">yaml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;yaml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">subtitle</span><span class="o">=</span><span class="n">subtitle</span><span class="p">,</span>
                <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span>
                <span class="n">font_size</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
                <span class="n">pdf_engine</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
            <span class="p">)</span>
            <span class="n">yaml</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;toc: false&#39;</span><span class="p">,</span> <span class="s1">&#39;toc: true&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">handout</span><span class="p">:</span>
                <span class="n">yaml</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,handout&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yaml</span><span class="p">)</span>
            <span class="n">dfl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dfl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hash_list</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">cat</span><span class="p">())</span></div>

<div class="viewcode-block" id="PresentationManager.toggle_debug"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManager.toggle_debug">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onoff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ``onoff == on``  set debug=True but remember previous state</span>
<span class="sd">        ``onoff == off`` restore previous state</span>
<span class="sd">        :param onoff:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">onoff</span> <span class="o">==</span> <span class="s2">&quot;on&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">elif</span> <span class="n">onoff</span> <span class="o">==</span> <span class="s1">&#39;off&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug_state</span></div></div>


<div class="viewcode-block" id="PresentationManagerMagic"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManagerMagic">[docs]</a><span class="nd">@magics_class</span>
<span class="k">class</span> <span class="nc">PresentationManagerMagic</span><span class="p">(</span><span class="n">Magics</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    description: implements magics to help using PresentationManager class</span>

<span class="sd">    pmt = pres maker text (blob, write)</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PresentationManagerMagic.pmb"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManagerMagic.pmb">[docs]</a>    <span class="nd">@line_cell_magic</span>
    <span class="nd">@magic_arguments</span><span class="p">(</span><span class="s1">&#39;%pmb&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--appendix&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mark as appendix material.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--code&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enclose in triple quotes as Python code.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Turn debug on temporarilty .&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--fstring&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Convert cell into f string and evaluate.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;--front&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mark as front matter, before the toc.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--ignore&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ignore the cell, turns it into a comment&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--tacit&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Tacit: suppress output as Markdown&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--summary&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mark as summary material (exlusive with appendix).&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pmb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PresentationManager blob (text/write) line/cell magic</span>

<span class="sd">        %pmt line  -&gt; written to body</span>
<span class="sd">        %%pmt -s -a -m  (s show; a=appendix, m=suMmary)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ex</span><span class="p">(</span><span class="s1">&#39;if PM.debug: logger.warning(f&quot;PM debug mode set to </span><span class="si">{PM.debug}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># defaults, tacit for everything except sections</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;# &#39;</span><span class="p">:</span>
                <span class="n">tacit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tacit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PM.text(&quot;</span><span class="se">\\</span><span class="s1">n</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s1">&quot;, buf=&quot;body&quot;, tacit=</span><span class="si">{</span><span class="n">tacit</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">parse_argstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pmb</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;body&#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">appendix</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;appendix&#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">summary</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;summary&#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">front</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;front&#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fstring</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;evaluating as f string&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">code</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;f&quot;&quot;&quot;</span><span class="se">\\\\\\\\</span><span class="s1">footnotesize</span><span class="se">\n\n</span><span class="s1">```python</span><span class="se">\n</span><span class="si">{</span><span class="n">cell</span><span class="si">}</span><span class="se">\n</span><span class="s1">```</span><span class="se">\n\\\\\\\\</span><span class="s1">normalsize&quot;&quot;&quot;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;f&quot;&quot;&quot;</span><span class="si">{</span><span class="n">cell</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;&#39;</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="s1">&#39;PM.toggle_debug(&quot;on&quot;)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PM.text(&quot;&quot;&quot;</span><span class="si">{</span><span class="n">cell</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;, buf=&quot;</span><span class="si">{</span><span class="n">buf</span><span class="si">}</span><span class="s1">&quot;, tacit=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">tacit</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="s1">&#39;PM.toggle_debug(&quot;off&quot;)&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManagerMagic.pmf"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManagerMagic.pmf">[docs]</a>    <span class="nd">@line_cell_magic</span>
    <span class="nd">@magic_arguments</span><span class="p">(</span><span class="s1">&#39;%pmf&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--appendix&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mark as appendix material.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--command&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Load the underlying command into the current cell&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Turn debug on temporarilty .&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--fstring&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Convert caption into f string and evaluate.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;--height&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Vertical size, generates height=height clause.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--ignore&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ignore the cell, turns into a comment&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--new_slide&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set to suppress new slide.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--option&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set option for tables that vary with options, uses decorated top_value filename.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--promise&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Promise: write file but append nothing to stream&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--summary&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mark as summary material (exlusive with appendix).&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--tacit&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;tacit: suppress output as Markdown&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pmf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PresentationManager figure utility. Add a new figure to the stream, format and save as self.fig_format file.</span>

<span class="sd">        In line mode</span>

<span class="sd">            %pmf f @ label</span>
<span class="sd">            %pmf label         # assumes figure called f</span>

<span class="sd">        In cell mode</span>

<span class="sd">            %%pmf [options]</span>
<span class="sd">            f</span>
<span class="sd">            label text</span>
<span class="sd">            many lines of caption text</span>
<span class="sd">            caption continues.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ex</span><span class="p">(</span><span class="s1">&#39;if PM.debug: logger.warning(f&quot;PM debug mode set to </span><span class="si">{PM.debug}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cell</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">parse_argstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pmf</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;body&#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">appendix</span><span class="p">:</span> <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;appendix&#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">summary</span><span class="p">:</span> <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;summary&#39;</span>

            <span class="c1"># get rid of multiple new lines</span>
            <span class="n">stxt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">+&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stxt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">stxt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">stxt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stxt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stxt</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fstring</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;evaluating caption as f string&#39;</span><span class="p">)</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;f&quot;&quot;&quot;</span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;&#39;</span>
                    <span class="n">caption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;promise = PM.figure(</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">, &quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot;, buf=&quot;</span><span class="si">{</span><span class="n">buf</span><span class="si">}</span><span class="s1">&quot;, caption=&quot;&quot;&quot;</span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;, &#39;</span> \
                <span class="sa">f</span><span class="s1">&#39;new_slide=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">new_slide</span><span class="si">}</span><span class="s1">, tacit=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">tacit</span><span class="si">}</span><span class="s1">, promise=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">promise</span><span class="si">}</span><span class="s1">, option=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">option</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;, height=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">height</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># called as line magic: [fig] @ label or just label, uses f</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">sline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">sline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;promise = PM.figure(</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">, &quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot;, tacit=True, promise=True)&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_cell</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="s1">&#39;PM.toggle_debug(&quot;on&quot;)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ex</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="s1">&#39;PM.toggle_debug(&quot;off&quot;)&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManagerMagic.pmsave"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManagerMagic.pmsave">[docs]</a>    <span class="nd">@cell_magic</span>
    <span class="nd">@magic_arguments</span><span class="p">(</span><span class="s1">&#39;%pmsave&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--fstring&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Convert caption into f string and evaluate.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--ignore&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ignore the cell, turns into a comment&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--option&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set option for tables that vary with options, uses decorated top_value filename.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--variable&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Variable name for output, default promise&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pmsave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save the contents of the cell into a file</span>
<span class="sd">        e.g. with diagram get tikz blobs of text, write them to a file and return the promise</span>
<span class="sd">        %%pmsave</span>
<span class="sd">        filename: e.g. dir stem --&gt; dir/KEY-stem.md</span>
<span class="sd">        contents (either f string or not)</span>

<span class="sd">        sets promise = the relevant include string</span>
<span class="sd">        nothing is written to any buffer....that&#39;s up to you</span>
<span class="sd">        :param line:</span>
<span class="sd">        :param cell:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parse_argstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pmsave</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># manipulation common to both engines</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">stxt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">+&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stxt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
        <span class="nb">dir</span><span class="p">,</span> <span class="o">*</span><span class="n">filestem</span> <span class="o">=</span> <span class="n">stxt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">filestem</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filestem</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">filestem</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">stxt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fstring</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;evaluating f strings&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>
                <span class="n">body</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;f&quot;&quot;&quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;&#39;</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">variable</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">variable</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;promise&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1"> = PM.save(&quot;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="n">filestem</span><span class="si">}</span><span class="s1">&quot;, &quot;&quot;&quot;</span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;, </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">option</span><span class="si">}</span><span class="s1">)&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="mi">100</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ex</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>

            <span class="c1">#</span>
            <span class="c1"># if args.fstring:</span>
            <span class="c1">#     logger.info(&#39;evaluating as f string&#39;)</span>
            <span class="c1">#     if args.code:</span>
            <span class="c1">#         temp = f&#39;f&quot;&quot;&quot;\\\\\\\\footnotesize\n\n```python\n{cell}\n```\n\\\\\\\\normalsize&quot;&quot;&quot;&#39;</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         temp = f&#39;f&quot;&quot;&quot;{cell}&quot;&quot;&quot;&#39;</span>
            <span class="c1">#     cell = self.shell.ev(temp)</span>
            <span class="c1"># self.shell.ev(f&#39;PM.text(&quot;&quot;&quot;{cell}&quot;&quot;&quot;, buf=&quot;{buf}&quot;, tacit={args.tacit})&#39;)</span>


<div class="viewcode-block" id="PresentationManagerMagic.pmt"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManagerMagic.pmt">[docs]</a>    <span class="nd">@line_cell_magic</span>
    <span class="nd">@magic_arguments</span><span class="p">(</span><span class="s1">&#39;%pmt&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;--appendix&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mark as appendix material.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--tabs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set tabs.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--command&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Load the underlying command into the current cell&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Turn debug on temporarilty .&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--fstring&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Convert caption into f string and evaluate.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-h&#39;</span><span class="p">,</span> <span class="s1">&#39;--hrule&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Horizontal rule locations eg 1,3,-1&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--ignore&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ignore the cell, turns into a comment&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--latex&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;latex switches applied to the float container, &#39;</span>
                                                           <span class="s1">&#39;h is the most useful&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--summary&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mark as summary material (exlusive with appendix).&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;--new_slide&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set to suppress new slide.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--option&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
              <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Set option for tables that vary with options, uses decorated top_value filename.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--promise&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Promise: write file but append nothing to stream&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;--equal&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Hint the column widths should be equal&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;--wide&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use wide table mode, WIDE number of columns&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--format&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Indicates the last line of input is a float_format function&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--scale&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Scale for tikz&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--tacit&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;tacit: suppress output as Markdown.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--underscore&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply de_underscore prior to formatting.&#39;</span><span class="p">)</span>
    <span class="nd">@argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--vrule&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Vertical rule locations, to left of col no&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PresentationManager table utility. Add a new table to the stream, format and save as TeX file.</span>

<span class="sd">        In line mode</span>

<span class="sd">            %pmt df @ label</span>
<span class="sd">            %pmt label         # assumes table called df</span>

<span class="sd">        In cell mode</span>

<span class="sd">            %%pmt [options</span>
<span class="sd">            df</span>
<span class="sd">            label text</span>
<span class="sd">            many lines of caption text</span>
<span class="sd">            caption continues</span>

<span class="sd">        tabs.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ex</span><span class="p">(</span><span class="s1">&#39;if PM.debug: logger.warning(f&quot;PM debug mode set to </span><span class="si">{PM.debug}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cell</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">parse_argstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pmt</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ignore</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1"># manipulation common to both engines</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;body&#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">appendix</span><span class="p">:</span> <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;appendix&#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">summary</span><span class="p">:</span> <span class="n">buf</span> <span class="o">=</span> <span class="s1">&#39;summary&#39;</span>
            <span class="c1"># get rid of multiple new lines</span>
            <span class="n">stxt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">+&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">stxt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">stxt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">stxt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">:</span>
                <span class="n">ff</span> <span class="o">=</span> <span class="n">stxt</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stxt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stxt</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fstring</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;evaluating caption as f string&#39;</span><span class="p">)</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;f&quot;&quot;&quot;</span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;&#39;</span>
                    <span class="n">caption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
            <span class="n">hrule</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">hrule</span>
            <span class="n">vrule</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">vrule</span>
            <span class="n">equal</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">equal</span>
            <span class="n">option</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">option</span>
            <span class="n">tabs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tabs</span>
            <span class="n">latex</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">latex</span>
            <span class="k">if</span> <span class="n">tabs</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">tabs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tabs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">hrule</span><span class="p">:</span>
                <span class="n">hrule</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">hrule</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">vrule</span><span class="p">:</span>
                <span class="n">vrule</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vrule</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error converting args.scale </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s1"> to float; valid options&#39;</span><span class="p">)</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">underscore</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;promise = PM.tikz_table(grt.de_underscore(</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s1">), &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;promise = PM.tikz_table(</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span>  <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot;, buf=&quot;</span><span class="si">{</span><span class="n">buf</span><span class="si">}</span><span class="s1">&quot;, caption=&quot;&quot;&quot;</span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s1">&quot;&quot;&quot;, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;new_slide=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">new_slide</span><span class="si">}</span><span class="s1">, &#39;</span> 
                    <span class="sa">f</span><span class="s1">&#39;tacit=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">tacit</span><span class="si">}</span><span class="s1">, promise=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">promise</span><span class="si">}</span><span class="s1">, &#39;</span> 
                    <span class="sa">f</span><span class="s1">&#39;hrule=</span><span class="si">{</span><span class="n">hrule</span><span class="si">}</span><span class="s1">, vrule=</span><span class="si">{</span><span class="n">vrule</span><span class="si">}</span><span class="s1">, scale=</span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="s1">, &#39;</span> 
                    <span class="sa">f</span><span class="s1">&#39;equal=</span><span class="si">{</span><span class="n">equal</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;option=</span><span class="si">{</span><span class="n">option</span><span class="si">}</span><span class="s1">, &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;latex=&quot;</span><span class="si">{</span><span class="n">latex</span><span class="si">}</span><span class="s1">&quot;, &#39;</span>
                    <span class="s1">&#39;sparsify=1, figure=&quot;table&quot;&#39;</span> <span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tabs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;, tabs=</span><span class="si">{</span><span class="n">tabs</span><span class="si">}</span><span class="s1"> &#39;</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">format</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;, float_format=</span><span class="si">{</span><span class="n">ff</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># called as line magic: [table] @ label or just label, uses bit</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">sline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">sline</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="s1">&#39;bit&#39;</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;promise = PM.table(</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s1">, &quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot;, tacit=True, promise=True)&#39;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;command:</span><span class="se">\n\n</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_cell</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="s1">&#39;PM.toggle_debug(&quot;on&quot;)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ex</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="s1">&#39;PM.toggle_debug(&quot;off&quot;)&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManagerMagic.load_cell"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManagerMagic.load_cell">[docs]</a>    <span class="k">def</span> <span class="nf">load_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load s into the cell in a nicely formatted manner</span>

<span class="sd">        :param s:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sps</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">sps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">sps</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">space</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">n</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">sps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span><span class="p">:]</span><span class="si">}</span><span class="s1">,</span><span class="se">\n</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;,</span><span class="se">\n</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sps</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;# %%pmt </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="se">\n</span><span class="s1"># &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">set_next_input</span><span class="p">(</span><span class="n">contents</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManagerMagic.pmbuf"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManagerMagic.pmbuf">[docs]</a>    <span class="nd">@line_magic</span>
    <span class="k">def</span> <span class="nf">pmbuf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="s1">&#39;print(PM.buffer())&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PresentationManagerMagic.qc"><a class="viewcode-back" href="../../code.html#great.pres_maker.PresentationManagerMagic.qc">[docs]</a>    <span class="nd">@cell_magic</span>
    <span class="k">def</span> <span class="nf">qc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        quick calculation: skip calculation if the variables listed in line</span>
<span class="sd">        exist in globals.</span>

<span class="sd">        use responsibly to avoid recomputing expensive items!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">sline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">user_ns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sline</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">status</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Skipping recalc: all of </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s1"> variables exist.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Recomputing cell: missing variables.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">ex</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_sparsify</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sparsify col values, col a pd.Series or dict, with items and accessor</span>
<span class="sd">    column results from a reset_index so has index 0,1,2... this is relied upon.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">last</span><span class="p">:</span>
            <span class="n">new_col</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">new_col</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">new_col</span><span class="p">,</span> <span class="n">rules</span>


<span class="k">def</span> <span class="nf">_sparsify_mi</span><span class="p">(</span><span class="n">mi</span><span class="p">,</span> <span class="n">bottom_level</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    as above for a multi index level, without the benefit of the index...</span>
<span class="sd">    really all should use this function</span>
<span class="sd">    :param mi:</span>
<span class="sd">    :param bottom_level: for the lowest level ... all values repeated, no sparsificaiton</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">mi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_col</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">last</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bottom_level</span><span class="p">:</span>
            <span class="n">new_col</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">new_col</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">new_col</span><span class="p">,</span> <span class="n">rules</span>


<div class="viewcode-block" id="df_to_tikz"><a class="viewcode-back" href="../../code.html#great.pres_maker.df_to_tikz">[docs]</a><span class="k">def</span> <span class="nf">df_to_tikz</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">fn_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">show_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.717</span><span class="p">,</span> <span class="n">column_sep</span><span class="o">=</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">row_sep</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>
               <span class="n">figure</span><span class="o">=</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="n">extra_defs</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">hrule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">vrule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">post_process</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">sparsify</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">clean_index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write DataFrame to custom tikz matrix to allow greater control of</span>
<span class="sd">    formatting and insertion of horizontal divider lines</span>

<span class="sd">    Estimates tabs from text width of fields (not so great if includes TeX);</span>
<span class="sd">    manual override available. Tabs gives the widths of each field in</span>
<span class="sd">    em (width of M)</span>

<span class="sd">    Standard row height = 1.5em seems to work - set in meta</span>

<span class="sd">    first and last thick rules by default</span>
<span class="sd">    others below (Python, zero-based) row number, excluding title row</span>

<span class="sd">    keyword arguments : value (no newlines in value) escape back slashes!</span>
<span class="sd">    ``#keyword...`` rows ignored</span>
<span class="sd">    passed in as a string to facilitate using them with %%pmt?</span>

<span class="sd">    **Rules**</span>

<span class="sd">    * hrule at i means below row i of the table. (1-based) Top, bottom and below index lines</span>
<span class="sd">      are inserted automatically. Top and bottom lines are thicker.</span>
<span class="sd">    * vrule at i means to the left of table column i (1-based); there will never be a rule to the far</span>
<span class="sd">      right...it looks plebby; remember you must include the index columns!</span>

<span class="sd">    sparsify  number of cols of multi index to sparsify</span>

<span class="sd">    Issue: colunn with floats and spaces or missing causess problems (VaR, TVaR, EPD, mean and CV table)</span>

<span class="sd">    keyword args:</span>

<span class="sd">        scale           scale applied to whole table - default 0.717</span>
<span class="sd">        height          row height, rec. 1 (em)</span>
<span class="sd">        column_sep      col sep in em</span>
<span class="sd">        row_sep         row sep in em</span>
<span class="sd">        figure          table, figure or sidewaysfigure</span>
<span class="sd">        color           color for text boxes (helps debugging)</span>
<span class="sd">        extra_defs      TeX defintions and commands put at top of table, e.g., \\centering</span>
<span class="sd">        lines           lines below these rows, -1 for next to last row etc.; list of ints</span>
<span class="sd">        post_process    e.g., non-line commands put at bottom of table</span>
<span class="sd">        label</span>
<span class="sd">        latex           arguments after \begin{table}[latex]</span>
<span class="sd">        caption         text for caption</span>

<span class="sd">    Original version see: C:\\S\\TELOS\\CAS\\AR_Min_Bias\\cvs_to_md.py</span>

<span class="sd">    :param df:</span>
<span class="sd">    :param fn_out:</span>
<span class="sd">    :param float_format:</span>
<span class="sd">    :param tabs:</span>
<span class="sd">    :param show_index:</span>
<span class="sd">    :param scale:</span>
<span class="sd">    :param column_sep:</span>
<span class="sd">    :param row_sep:</span>
<span class="sd">    :param figure:</span>
<span class="sd">    :param color:</span>
<span class="sd">    :param extra_defs:</span>
<span class="sd">    :param lines:</span>
<span class="sd">    :param post_process:</span>
<span class="sd">    :param label:</span>
<span class="sd">    :param caption:</span>
<span class="sd">    :return:</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="se">\\</span><span class="s2">begin{{</span><span class="si">{figure}</span><span class="s2">}}</span><span class="si">{latex}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">centering</span>
<span class="si">{extra_defs}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">begin{{tikzpicture}}[</span>
<span class="s2">    auto,</span>
<span class="s2">    transform shape,</span>
<span class="s2">    nosep/.style={{inner sep=0}},</span>
<span class="s2">    table/.style={{</span>
<span class="s2">        matrix of nodes,</span>
<span class="s2">        row sep=</span><span class="si">{row_sep}</span><span class="s2">em,</span>
<span class="s2">        column sep=</span><span class="si">{column_sep}</span><span class="s2">em,</span>
<span class="s2">        nodes in empty cells,</span>
<span class="s2">        nodes={{rectangle, scale=</span><span class="si">{scale}</span><span class="s2">, text badly ragged}},</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="c1"># put draw=blue!10 or so in nodes to see the node</span>


    <span class="n">footer</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="si">{post_process}</span><span class="s2"></span>

<span class="se">\\</span><span class="s2">end{{tikzpicture}}</span>
<span class="si">{caption}</span><span class="s2"></span>
<span class="se">\\</span><span class="s2">end{{</span><span class="si">{figure}</span><span class="s2">}}</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="c1"># make a safe float format</span>
    <span class="k">if</span> <span class="n">float_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wfloat_format</span> <span class="o">=</span> <span class="n">PresentationManager</span><span class="o">.</span><span class="n">default_float_format</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If you pass in a lambda function it won&#39;t have error handling</span>
        <span class="k">def</span> <span class="nf">_ff</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">float_format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span>
        <span class="n">wfloat_format</span> <span class="o">=</span> <span class="n">_ff</span>

    <span class="k">if</span> <span class="n">clean_index</span><span class="p">:</span>
        <span class="c1"># dont use the index</span>
        <span class="c1"># but you do use the columns, this does both</span>
        <span class="c1"># logger.debug(df.columns)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">PresentationManager</span><span class="o">.</span><span class="n">clean_index</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># logger.debug(df.columns)</span>

    <span class="c1"># index</span>
    <span class="k">if</span> <span class="n">show_index</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="n">nc_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span>
            <span class="c1"># df = df.copy().reset_index(drop=False, col_level=df.columns.nlevels - 1)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nc_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col_level</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sparsify</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hrule</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sparsify</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">rules</span> <span class="o">=</span> <span class="n">_sparsify</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="c1"># print(rules, len(rules), len(df))</span>
            <span class="c1"># don&#39;t want lines everywhere</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">hrule</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">hrule</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nc_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># this is handled by the caller</span>
    <span class="c1"># df = df.astype(float, errors=&#39;ignore&#39;)</span>

    <span class="k">if</span> <span class="n">nc_index</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vrule</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vrule</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vrule</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vrule</span><span class="p">)</span>
        <span class="c1"># to the left of... +1</span>
        <span class="n">vrule</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nc_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
        <span class="n">nr_columns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nr_columns</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rows in columns </span><span class="si">{</span><span class="n">nr_columns</span><span class="si">}</span><span class="s1">, cols in index </span><span class="si">{</span><span class="n">nc_index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># internal TeX code</span>
    <span class="n">matrix_name</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="p">))))</span>

    <span class="c1"># note this happens AFTER you have reset the index...need to pass number of index columns</span>
    <span class="n">colw</span><span class="p">,</span> <span class="n">mxmn</span><span class="p">,</span> <span class="n">tabs</span> <span class="o">=</span> <span class="n">guess_column_widths</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">nc_index</span><span class="o">=</span><span class="n">nc_index</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="n">wfloat_format</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="n">tabs</span><span class="p">,</span>
                                           <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="n">equal</span><span class="p">)</span>
    <span class="c1"># print(colw, tabs)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tabs: </span><span class="si">{</span><span class="n">tabs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># alignment dictionaries</span>
    <span class="n">ad</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">}</span>
    <span class="n">ad2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;^&#39;</span><span class="p">}</span>
    <span class="c1"># guess alignments: TODO add dates?</span>
    <span class="n">align</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">mxmn</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">n</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">align</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">align</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">object</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">align</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">object</span><span class="p">:</span>
            <span class="n">align</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;l&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">align</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">align</span><span class="p">)</span>

    <span class="c1"># start writing</span>
    <span class="n">sio</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">latex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">latex</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">latex</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">latex</span><span class="si">}</span><span class="s1">]&#39;</span>
    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span> <span class="n">extra_defs</span><span class="o">=</span><span class="n">extra_defs</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">column_sep</span><span class="o">=</span><span class="n">column_sep</span><span class="p">,</span>
                            <span class="n">row_sep</span><span class="o">=</span><span class="n">row_sep</span><span class="p">,</span> <span class="n">latex</span><span class="o">=</span><span class="n">latex</span><span class="p">))</span>

    <span class="c1"># table header</span>
    <span class="c1"># title rows, start with the empty spacer row</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">/.style=</span><span class="se">{{</span><span class="s1">nodes=</span><span class="se">{{</span><span class="s1">text=black, anchor=north, inner ysep=0, text height=0, text depth=0</span><span class="se">}}}}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nr_columns</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">/.style=</span><span class="se">{{</span><span class="s1">nodes=</span><span class="se">{{</span><span class="s1">text=black, anchor=south, inner ysep=.2em, minimum height=1.3em, font=</span><span class="se">\\</span><span class="s1">bfseries</span><span class="se">}}}}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># write column spec</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">al</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">align</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">tabs</span><span class="p">,</span> <span class="n">align</span><span class="p">):</span>
        <span class="c1"># average char is only 0.48 of M</span>
        <span class="c1"># https://en.wikipedia.org/wiki/Em_(gtypography)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># first column sets row height for entire row</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">column </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">&gt;2d</span><span class="si">}</span><span class="s1">/.style=</span><span class="se">{{</span><span class="s1">&#39;</span> 
                  <span class="sa">f</span><span class="s1">&#39;nodes=</span><span class="se">{{</span><span class="s1">align=</span><span class="si">{</span><span class="n">ad</span><span class="p">[</span><span class="n">al</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;6s</span><span class="se">}}</span><span class="si">}</span><span class="s1">, text height=0.9em, text depth=0.2em, &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;inner xsep=</span><span class="si">{</span><span class="n">column_sep</span><span class="si">}</span><span class="s1">em, inner ysep=0, &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;text width=</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">em</span><span class="se">}}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">column </span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">&gt;2d</span><span class="si">}</span><span class="s1">/.style=</span><span class="se">{{</span><span class="s1">&#39;</span> 
                  <span class="sa">f</span><span class="s1">&#39;nodes=</span><span class="se">{{</span><span class="s1">align=</span><span class="si">{</span><span class="n">ad</span><span class="p">[</span><span class="n">al</span><span class="p">]</span><span class="si">:</span><span class="s1">&lt;6s</span><span class="se">}}</span><span class="si">}</span><span class="s1">, nosep, text width=</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">em</span><span class="se">}}</span><span class="s1">,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># extra col to right which enforces row height</span>
    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">column </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">:</span><span class="s1">&gt;2d</span><span class="si">}</span><span class="s1">/.style=</span><span class="se">{{</span><span class="s1">text height=0.9em, text depth=0.2em, nosep, text width=0em</span><span class="se">}}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">}]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">matrix (</span><span class="si">{matrix_name}</span><span class="s2">) [table, ampersand replacement=</span><span class="se">\\</span><span class="s2">&amp;]{{</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matrix_name</span><span class="o">=</span><span class="n">matrix_name</span><span class="p">))</span>

    <span class="c1"># body of table, starting with the column headers</span>
    <span class="c1"># spacer row</span>
    <span class="n">nl</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">al</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">align</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nl</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1">cell:</span><span class="si">{</span><span class="n">ad2</span><span class="p">[</span><span class="n">al</span><span class="p">]</span><span class="si">}{</span><span class="n">colw</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="si">}</span><span class="s1">s</span><span class="se">}}</span><span class="s1"> &#39;</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp;&#39;</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
    <span class="c1"># include the blank extra last column</span>
    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp; </span><span class="se">\\\\\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># write header rows  (again, issues with multi index)</span>
    <span class="n">mi_vrules</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sparse_columns</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">lvl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">)):</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">sparse_columns</span><span class="p">[</span><span class="n">lvl</span><span class="p">],</span> <span class="n">mi_vrules</span><span class="p">[</span><span class="n">lvl</span><span class="p">]</span> <span class="o">=</span> <span class="n">_sparsify_mi</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="n">lvl</span><span class="p">),</span>
                                                               <span class="n">lvl</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">al</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">sparse_columns</span><span class="p">[</span><span class="n">lvl</span><span class="p">],</span> <span class="n">align</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">wfloat_format</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nl</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1">cell:</span><span class="si">{</span><span class="n">ad2</span><span class="p">[</span><span class="n">al</span><span class="p">]</span><span class="si">}{</span><span class="n">colw</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="si">}</span><span class="s1">s</span><span class="se">}}</span><span class="s1"> &#39;</span>
                <span class="n">nl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp;&#39;</span>
                <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">grtspacer&#39;</span><span class="p">))</span>
            <span class="c1"># include the blank extra last column</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp; </span><span class="se">\\\\\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">al</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">align</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">wfloat_format</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nl</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1">cell:</span><span class="si">{</span><span class="n">ad2</span><span class="p">[</span><span class="n">al</span><span class="p">]</span><span class="si">}{</span><span class="n">colw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="si">}</span><span class="s1">s</span><span class="se">}}</span><span class="s1"> &#39;</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp;&#39;</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">grtspacer&#39;</span><span class="p">))</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp; </span><span class="se">\\\\\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># write table entries</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">al</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">align</span><span class="p">):</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">wfloat_format</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nl</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1">cell:</span><span class="si">{</span><span class="n">ad2</span><span class="p">[</span><span class="n">al</span><span class="p">]</span><span class="si">}{</span><span class="n">colw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="si">}</span><span class="s1">s</span><span class="se">}}</span><span class="s1"> &#39;</span>
            <span class="n">nl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp;&#39;</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">))</span>
            <span class="c1"># if c==&#39;p&#39;:</span>
            <span class="c1">#     print(&#39;COLp&#39;, cell, type(cell), s, s.format(cell=cell))</span>
        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&amp; </span><span class="se">\\\\\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">}}</span><span class="s1">;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># decorations and post processing - horizontal and vertical lines</span>
    <span class="n">nr</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># add for the index and the last row plus 1 for the added spacer row at the top</span>
    <span class="n">nr</span> <span class="o">+=</span> <span class="n">nr_columns</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># always include top and bottom</span>
    <span class="c1"># you input a table row number and get a line below it; it is implemented as a line ABOVE the next row</span>
    <span class="c1"># function to convert row numbers to TeX table format (edge case on last row -1 is nr and is caught, -2</span>
    <span class="c1"># is below second to last row = above last row)</span>
    <span class="c1"># shift down extra 1 for the spacer row at the top</span>
    <span class="n">python_2_tex</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">nr_columns</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">nr</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">3</span>
    <span class="n">tb_rules</span> <span class="o">=</span> <span class="p">[</span><span class="n">nr_columns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">python_2_tex</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">hrule</span><span class="p">:</span>
        <span class="n">hrule</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">python_2_tex</span><span class="p">,</span> <span class="n">hrule</span><span class="p">))</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">tb_rules</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hrule</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tb_rules</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hlines: </span><span class="si">{</span><span class="n">hrule</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># why</span>
    <span class="n">yshift</span> <span class="o">=</span> <span class="n">row_sep</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">xshift</span> <span class="o">=</span> <span class="o">-</span><span class="n">column_sep</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">descender_proportion</span> <span class="o">=</span> <span class="mf">0.25</span>

    <span class="c1"># top rule is special</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="s1">&#39;thick&#39;</span>
    <span class="n">ln</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">path[draw, </span><span class="si">{</span><span class="n">ls</span><span class="si">}</span><span class="s1">] (</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ln</span><span class="si">}</span><span class="s1">-1.south west)  -- (</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ln</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">nc</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">.south east);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="n">hrule</span><span class="p">:</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="s1">&#39;thick&#39;</span> <span class="k">if</span> <span class="n">ln</span> <span class="o">==</span> <span class="n">nr</span> <span class="o">+</span> <span class="n">nr_columns</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;semithick&#39;</span> <span class="k">if</span> <span class="n">ln</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nr_columns</span> <span class="k">else</span> <span class="s1">&#39;very thin&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ln</span> <span class="o">&lt;</span> <span class="n">nr</span><span class="p">:</span>
            <span class="c1"># line above TeX row ln+1 that exists</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">path[draw, </span><span class="si">{</span><span class="n">ls</span><span class="si">}</span><span class="s1">] ([yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ln</span><span class="si">}</span><span class="s1">-1.south west)  -- &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;([yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ln</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">nc</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">.south east);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># line above row below bottom = line below last row</span>
            <span class="c1"># descenders are 200 to 300 below baseline</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="n">nr</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">path[draw, thick] ([yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">descender_proportion</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ln</span><span class="si">}</span><span class="s1">-1.base west)  -- &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;([yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">descender_proportion</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ln</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">nc</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">.base east);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># if multi index put in lines within the index TODO make this better!</span>
    <span class="k">if</span> <span class="n">nr_columns</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ln</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nr_columns</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">path[draw, very thin] ([xshift=</span><span class="si">{</span><span class="n">xshift</span><span class="si">}</span><span class="s1">em, yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em]&#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ln</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">nc_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">.south west)  -- &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;([yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">ln</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">nc</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">.south east);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">written</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nc_index</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">vrule</span><span class="p">:</span>
        <span class="c1"># to left of col, 1 based, includes index</span>
        <span class="c1"># write these first</span>
        <span class="c1"># TODO fix madness vrule is to the left, mi_vrules are to the right...</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="s1">&#39;very thin&#39;</span>
        <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">vrule</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">written</span><span class="p">:</span>
                <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">path[draw, </span><span class="si">{</span><span class="n">ls</span><span class="si">}</span><span class="s1">] ([xshift=</span><span class="si">{</span><span class="n">xshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-1-</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s1">.south west)  -- &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;([yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">descender_proportion</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em, xshift=</span><span class="si">{</span><span class="n">xshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s1">.base west);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">written</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cn</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mi_vrules</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Generated vlines </span><span class="si">{</span><span class="n">mi_vrules</span><span class="si">}</span><span class="s1">; already written </span><span class="si">{</span><span class="n">written</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># vertical rules for the multi index</span>
        <span class="c1"># these go to the RIGHT of the relevant column and reflect the index columns already</span>
        <span class="c1"># mi_vrules = {level of index: [list of vrule columns]</span>
        <span class="c1"># written keeps track of which vrules have been done already; start by cutting out the index columns</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="s1">&#39;ultra thin&#39;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">mi_vrules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># don&#39;t write the lowest level</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mi_vrules</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">written</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">written</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">top</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">path[draw, </span><span class="si">{</span><span class="n">ls</span><span class="si">}</span><span class="s1">] ([xshift=</span><span class="si">{</span><span class="o">-</span><span class="n">xshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s1">.south east)  -- &#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;([yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">descender_proportion</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em, xshift=</span><span class="si">{</span><span class="o">-</span><span class="n">xshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s1">.base east);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">path[draw, </span><span class="si">{</span><span class="n">ls</span><span class="si">}</span><span class="s1">] ([xshift=</span><span class="si">{</span><span class="o">-</span><span class="n">xshift</span><span class="si">}</span><span class="s1">em, yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">top</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s1">.south east)  -- &#39;</span>
                          <span class="sa">f</span><span class="s1">&#39;([yshift=</span><span class="si">{</span><span class="o">-</span><span class="n">descender_proportion</span><span class="o">-</span><span class="n">yshift</span><span class="si">}</span><span class="s1">em, xshift=</span><span class="si">{</span><span class="o">-</span><span class="n">xshift</span><span class="si">}</span><span class="s1">em]</span><span class="si">{</span><span class="n">matrix_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">nr</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s1">.base east);</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">lt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;}  % no label&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lt</span> <span class="o">=</span> <span class="n">label</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">label</span><span class="se">{{</span><span class="s1">tab:</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="se">}}</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">caption</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You have a label but no caption; the label </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> will be ignored.&#39;</span><span class="p">)</span>
        <span class="n">caption</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">% c</span><span class="s1">aption placeholder&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">caption</span><span class="se">{{</span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="se">}}</span><span class="s1">&#39;</span>
    <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">footer</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">figure</span><span class="o">=</span><span class="n">figure</span><span class="p">,</span> <span class="n">post_process</span><span class="o">=</span><span class="n">post_process</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="n">caption</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn_out</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="n">fn_out</span>
    <span class="k">elif</span> <span class="n">fn_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn_out</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fout</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">fout</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">fout</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">sio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>


<div class="viewcode-block" id="guess_column_widths"><a class="viewcode-back" href="../../code.html#great.pres_maker.guess_column_widths">[docs]</a><span class="k">def</span> <span class="nf">guess_column_widths</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">nc_index</span><span class="p">,</span> <span class="n">float_format</span><span class="p">,</span> <span class="n">tabs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">equal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    estimate sensible column widths for the dataframe [in what units?]</span>

<span class="sd">    :param df:</span>
<span class="sd">    :param nc_index: number of columns in the index...these are not counted as &quot;data columns&quot;</span>
<span class="sd">    :param float_format:</span>
<span class="sd">    :param tabs:</span>
<span class="sd">    :return:</span>
<span class="sd">        colw   affects how the table is printed in the md file (actual width of data elements)</span>
<span class="sd">        mxmn   affects aligmnent: are all columns the same width?</span>
<span class="sd">        tabs   affecets the actual output</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># this</span>
    <span class="c1"># tabs from _tabs, an estimate column widths, determines the size of the table columns as displayed</span>
    <span class="n">colw</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
    <span class="n">headw</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
    <span class="n">_tabs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mxmn</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nl</span> <span class="o">=</span> <span class="n">nc_index</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="c1"># figure width of the column labels; if index c= str, if MI then c = tuple</span>
        <span class="c1"># cw is the width of the column header/title</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nl</span><span class="p">:</span>
                <span class="n">cw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for data columns look at words rather than whole phrase</span>
                <span class="n">cw</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
                <span class="c1"># logger.info(f&#39;leng col = {len(c)}, longest word = {cw}&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># could be float etc.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cw</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">float_format</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># not a MI, float or something</span>
                <span class="n">cw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">headw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">cw</span>
        <span class="c1"># now figure the width of the elements in the column</span>
        <span class="c1"># mxmn is used to determine whether to center the column (if all the same size)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">object</span><span class="p">:</span>
            <span class="c1"># wierdness here were some objects actually contain floats, str evaluates to NaN</span>
            <span class="c1"># and picks up width zero</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># _ = list(map(lambda x: len(float_format(x)), df.iloc[:, i]))</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">float_format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">colw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">mxmn</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">_</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1"> error </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> DO SOMETHING ABOUT THIS...if it never occurs dont need the if&#39;</span><span class="p">)</span>
                <span class="n">colw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">mxmn</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># _ = list(map(lambda x: len(float_format(x)), df[c]))</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">float_format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="n">colw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">mxmn</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">_</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="c1"># debugging grief</span>
        <span class="c1"># if c == &#39;p&#39;:</span>
        <span class="c1">#     print(c, df[c], colw[c], mxmn[c], list(map(len, list(map(float_format, df[c])))))</span>
    <span class="k">if</span> <span class="n">tabs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># now know all column widths...decide what to do</span>
        <span class="c1"># are all the columns about the same width?</span>
        <span class="n">data_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">colw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">nl</span><span class="p">:]])</span>
        <span class="n">same_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_cols</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">data_cols</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="n">common_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">same_size</span><span class="p">:</span>
            <span class="n">common_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data_cols</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">data_cols</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;data cols appear same size = </span><span class="si">{</span><span class="n">common_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nl</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">same_size</span><span class="p">:</span>
                <span class="c1"># index columns</span>
                <span class="n">_tabs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">colw</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">headw</span><span class="p">[</span><span class="n">c</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># data all seems about the same width</span>
                <span class="n">_tabs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">common_size</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Determined tab spacing: </span><span class="si">{</span><span class="n">_tabs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">equal</span><span class="p">:</span>
            <span class="c1"># see if equal widths makes sense</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">_tabs</span><span class="p">[</span><span class="n">nl</span><span class="p">:]</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">_tabs</span> <span class="o">=</span> <span class="n">_tabs</span><span class="p">[:</span><span class="n">nl</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">dt</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_tabs</span><span class="p">)</span> <span class="o">-</span> <span class="n">nl</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Taking equal width hint: </span><span class="si">{</span><span class="n">_tabs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rejecting equal width hint&#39;</span><span class="p">)</span>
        <span class="c1"># look to rescale, shoot for width of 150 on 100 scale basis</span>
        <span class="n">data_width</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_tabs</span><span class="p">[</span><span class="n">nl</span><span class="p">:])</span>
        <span class="n">index_width</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_tabs</span><span class="p">[:</span><span class="n">nl</span><span class="p">])</span>
        <span class="n">target_width</span> <span class="o">=</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">-</span> <span class="n">index_width</span>
        <span class="k">if</span> <span class="n">data_width</span> <span class="o">/</span> <span class="n">target_width</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="c1"># don&#39;t rescale above 1:1 - don&#39;t want too large</span>
            <span class="n">rescale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span> <span class="n">target_width</span> <span class="o">/</span> <span class="n">data_width</span><span class="p">)</span>
            <span class="n">_tabs</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nl</span> <span class="k">else</span> <span class="n">w</span> <span class="o">*</span> <span class="n">rescale</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_tabs</span><span class="p">)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rescale </span><span class="si">{</span><span class="n">rescale</span><span class="si">}</span><span class="s1"> applied; tabs = </span><span class="si">{</span><span class="n">_tabs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">tabs</span> <span class="o">=</span> <span class="n">_tabs</span>

    <span class="k">return</span> <span class="n">colw</span><span class="p">,</span> <span class="n">mxmn</span><span class="p">,</span> <span class="n">tabs</span></div>


<div class="viewcode-block" id="de_underscore"><a class="viewcode-back" href="../../code.html#great.pres_maker.de_underscore">[docs]</a><span class="k">def</span> <span class="nf">de_underscore</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    remove underscores from index and / or columns, replacing with space</span>
<span class="sd">    Note, default behavior is to quote underscores</span>

<span class="sd">    :param df:</span>
<span class="sd">    :param which: row column b[oth]</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># workers</span>
    <span class="k">def</span> <span class="nf">de_</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        replace underscores with space</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">n</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">n</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">multi_de_</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; de_ for multiindex &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">levels</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lv</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                <span class="n">repl</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">de_</span><span class="p">,</span> <span class="n">lv</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="n">repl</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idx</span>

    <span class="c1"># work</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">idx_names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
    <span class="n">col_names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span>

    <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">multi_de_</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">de_</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">multi</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">multi_de_</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">de_</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">de_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_names</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">de_</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="int_to_roman"><a class="viewcode-back" href="../../code.html#great.pres_maker.int_to_roman">[docs]</a><span class="k">def</span> <span class="nf">int_to_roman</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mi">1000</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span>
        <span class="mi">100</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span>
        <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
        <span class="mi">1</span>
        <span class="p">]</span>
    <span class="n">syb</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;CM&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;CD&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;XC&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;XL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;IX&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;IV&quot;</span><span class="p">,</span>
        <span class="s2">&quot;I&quot;</span>
        <span class="p">]</span>
    <span class="n">roman_num</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span> <span class="o">//</span> <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">roman_num</span> <span class="o">+=</span> <span class="n">syb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">num</span> <span class="o">-=</span> <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">roman_num</span></div>


<span class="n">ip</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>
<span class="k">if</span> <span class="n">ip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ip</span><span class="o">.</span><span class="n">register_magics</span><span class="p">(</span><span class="n">PresentationManagerMagic</span><span class="p">)</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Stephen J Mildenhall.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>